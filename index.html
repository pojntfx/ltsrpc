<!DOCTYPE html><html class="default" lang="en"><head><meta charSet="utf-8"/><meta http-equiv="x-ua-compatible" content="IE=edge"/><title>@pojntfx/panrpc</title><meta name="description" content="Documentation for @pojntfx/panrpc"/><meta name="viewport" content="width=device-width, initial-scale=1"/><link rel="stylesheet" href="assets/style.css"/><link rel="stylesheet" href="assets/highlight.css"/><script async src="assets/search.js" id="search-script"></script></head><body><script>document.documentElement.dataset.theme = localStorage.getItem("tsd-theme") || "os"</script><header class="tsd-page-toolbar">
<div class="tsd-toolbar-contents container">
<div class="table-cell" id="tsd-search" data-base=".">
<div class="field"><label for="tsd-search-field" class="tsd-widget tsd-toolbar-icon search no-caption"><svg width="16" height="16" viewBox="0 0 16 16" fill="none"><path d="M15.7824 13.833L12.6666 10.7177C12.5259 10.5771 12.3353 10.499 12.1353 10.499H11.6259C12.4884 9.39596 13.001 8.00859 13.001 6.49937C13.001 2.90909 10.0914 0 6.50048 0C2.90959 0 0 2.90909 0 6.49937C0 10.0896 2.90959 12.9987 6.50048 12.9987C8.00996 12.9987 9.39756 12.4863 10.5008 11.6239V12.1332C10.5008 12.3332 10.5789 12.5238 10.7195 12.6644L13.8354 15.7797C14.1292 16.0734 14.6042 16.0734 14.8948 15.7797L15.7793 14.8954C16.0731 14.6017 16.0731 14.1267 15.7824 13.833ZM6.50048 10.499C4.29094 10.499 2.50018 8.71165 2.50018 6.49937C2.50018 4.29021 4.28781 2.49976 6.50048 2.49976C8.71001 2.49976 10.5008 4.28708 10.5008 6.49937C10.5008 8.70852 8.71314 10.499 6.50048 10.499Z" fill="var(--color-text)"></path></svg></label><input type="text" id="tsd-search-field" aria-label="Search"/></div>
<div class="field">
<div id="tsd-toolbar-links"></div></div>
<ul class="results">
<li class="state loading">Preparing search index...</li>
<li class="state failure">The search index is not available</li></ul><a href="index.html" class="title">@pojntfx/panrpc</a></div>
<div class="table-cell" id="tsd-widgets"><a href="#" class="tsd-widget tsd-toolbar-icon menu no-caption" data-toggle="menu" aria-label="Menu"><svg width="16" height="16" viewBox="0 0 16 16" fill="none"><rect x="1" y="3" width="14" height="2" fill="var(--color-text)"></rect><rect x="1" y="7" width="14" height="2" fill="var(--color-text)"></rect><rect x="1" y="11" width="14" height="2" fill="var(--color-text)"></rect></svg></a></div></div></header>
<div class="container container-main">
<div class="col-8 col-content">
<div class="tsd-page-title">
<h2>@pojntfx/panrpc</h2></div>
<div class="tsd-panel tsd-typography"><img alt="Project icon" style="vertical-align: middle;" src="./docs/icon.svg" width="128" height="128" align="left">


<a href="#panrpc" id="panrpc" style="color: inherit; text-decoration: none;">
  <h1>panrpc</h1>
</a>
<p>Language-, transport- and serialization-agnostic RPC framework with remote closure support that allows exposing and calling functions on both clients and servers.</p>
<p><a href="https://github.com/pojntfx/panrpc/actions/workflows/hydrun.yaml"><img src="https://github.com/pojntfx/panrpc/actions/workflows/hydrun.yaml/badge.svg" alt="hydrun CI"></a>
<img src="https://img.shields.io/badge/go%20version-%3E=1.18-61CFDD.svg" alt="Go Version">
<a href="https://pkg.go.dev/github.com/pojntfx/panrpc"><img src="https://pkg.go.dev/badge/github.com/pojntfx/panrpc.svg" alt="Go Reference"></a>
<a href="https://github.com/pojntfx/panrpc/actions/workflows/npm.yaml"><img src="https://github.com/pojntfx/panrpc/actions/workflows/npm.yaml/badge.svg" alt="npm CI"></a>
<a href="https://www.npmjs.com/package/@pojntfx/panrpc"><img src="https://img.shields.io/npm/v/@pojntfx/panrpc" alt="npm: @pojntfx/panrpc"></a>
<a href="https://pojntfx.github.io/panrpc"><img src="https://img.shields.io/badge/TypeScript%20-docs-blue.svg" alt="TypeScript docs"></a>
<a href="https://matrix.to/#/#panrpc:matrix.org?via=matrix.org"><img src="https://img.shields.io/matrix/panrpc:matrix.org" alt="Matrix"></a></p>

<a href="#overview" id="overview" style="color: inherit; text-decoration: none;">
  <h2>Overview</h2>
</a>
<p>panrpc is a flexible high-performance RPC framework designed to work in almost any environment with advanced features such as remote closures and bidirectional RPC calls.</p>
<p>It enables you to ...</p>
<ul>
<li><strong>Transparently call and expose RPCs in many languages</strong>: Thanks to it&#39;s use of reflection, panrpc doesn&#39;t require you to learn a DSL or run a code generator. RPCs are defined and called as local functions, and its <a href="#protocol">simple protocol</a> means that <a href="#examples">multiple languages</a> are supported and adding support for new ones is simple.</li>
<li><strong>Work with any transport layer</strong>: Instead of being restricted to one transport layer (like TCP or WebSockets for most RPC frameworks), panrpc depends only on the semantics of a <a href="https://pkg.go.dev/github.com/pojntfx/panrpc/pkg/rpc#LinkStream">stream</a> or a <a href="https://pkg.go.dev/github.com/pojntfx/panrpc/pkg/rpc#LinkMessage">message</a>, meaning it works over everything from TCP, WebSockets, UNIX sockets, WebRTC, Redis, NATS and more.</li>
<li><strong>Work with any serializer</strong>: Instead of being restricted to one serialization framework (like Protobuf or JSON for most RPC frameworks), panrpc can use any user-defined serializer that supports streaming encode/decode, such as JSON, CBOR and others.</li>
<li><strong>Call RPCs on both clients and servers</strong>: Unlike most RPC frameworks, which only allow you to call a server&#39;s RPCs from a client, panrpc can also work with the reverse configuration (where the server calls RPCs exposed by the client) or both at the same time.</li>
<li><strong>Pass closures to RPCs</strong>: You can transparently pass closures and callbacks to RPCs as function parameters, and they will be called by the RPC just like if it were a local function call.</li>
</ul>

<a href="#installation" id="installation" style="color: inherit; text-decoration: none;">
  <h2>Installation</h2>
</a>

<a href="#library" id="library" style="color: inherit; text-decoration: none;">
  <h3>Library</h3>
</a>
<p>You can add panrpc to your <img alt="Go" src="https://cdn.simpleicons.org/go" style="vertical-align: middle;" height="20" width="20" /> <strong>Go</strong> project by running the following:</p>
<pre><code class="language-shell"><span class="hl-0">$</span><span class="hl-1"> </span><span class="hl-2">go</span><span class="hl-1"> </span><span class="hl-2">get</span><span class="hl-1"> </span><span class="hl-2">github.com/pojntfx/panrpc/...@latest</span>
</code></pre>
<p>For <img alt="typescript" src="https://cdn.simpleicons.org/typescript" style="vertical-align: middle;" height="20" width="20" /> <strong>TypeScript</strong>, you can add panrpc to your project (both server-side TypeScript/Node.js and all major browser engines are supported) by running the following:</p>
<pre><code class="language-shell"><span class="hl-0">$</span><span class="hl-1"> </span><span class="hl-2">npm</span><span class="hl-1"> </span><span class="hl-2">install</span><span class="hl-1"> </span><span class="hl-2">@pojntfx/panrpc</span>
</code></pre>

<a href="#purl-tool" id="purl-tool" style="color: inherit; text-decoration: none;">
  <h3><code>purl</code> Tool</h3>
</a>
<p>In addition to the library, the CLI tool <code>purl</code> is also available; <code>purl</code> is like <a href="https://curl.se/">cURL</a> and <a href="https://github.com/fullstorydev/grpcurl">gRPCurl</a>, but for panrpc: A command-line tool for interacting with panrpc servers. <code>purl</code> is provided in the form of static binaries.</p>
<p>On Linux, you can install them like so:</p>
<pre><code class="language-shell"><span class="hl-0">$</span><span class="hl-1"> </span><span class="hl-2">curl</span><span class="hl-1"> </span><span class="hl-3">-L</span><span class="hl-1"> </span><span class="hl-3">-o</span><span class="hl-1"> </span><span class="hl-2">/tmp/purl</span><span class="hl-1"> </span><span class="hl-2">&quot;https://github.com/pojntfx/panrpc/releases/latest/download/purl.linux-$(</span><span class="hl-0">uname</span><span class="hl-2"> </span><span class="hl-3">-m</span><span class="hl-2">)&quot;</span><br/><span class="hl-0">$</span><span class="hl-1"> </span><span class="hl-2">sudo</span><span class="hl-1"> </span><span class="hl-2">install</span><span class="hl-1"> </span><span class="hl-2">/tmp/purl</span><span class="hl-1"> </span><span class="hl-2">/usr/local/bin</span>
</code></pre>
<p>On macOS, you can use the following:</p>
<pre><code class="language-shell"><span class="hl-0">$</span><span class="hl-1"> </span><span class="hl-2">curl</span><span class="hl-1"> </span><span class="hl-3">-L</span><span class="hl-1"> </span><span class="hl-3">-o</span><span class="hl-1"> </span><span class="hl-2">/tmp/purl</span><span class="hl-1"> </span><span class="hl-2">&quot;https://github.com/pojntfx/panrpc/releases/latest/download/purl.darwin-$(</span><span class="hl-0">uname</span><span class="hl-2"> </span><span class="hl-3">-m</span><span class="hl-2">)&quot;</span><br/><span class="hl-0">$</span><span class="hl-1"> </span><span class="hl-2">sudo</span><span class="hl-1"> </span><span class="hl-2">install</span><span class="hl-1"> </span><span class="hl-2">/tmp/purl</span><span class="hl-1"> </span><span class="hl-2">/usr/local/bin</span>
</code></pre>
<p>On Windows, the following should work (using PowerShell as administrator):</p>
<pre><code class="language-PowerShell"><span class="hl-0">Invoke-WebRequest</span><span class="hl-1"> https://</span><span class="hl-0">github.com</span><span class="hl-1">/pojntfx/panrpc/releases/latest/download/</span><span class="hl-0">purl.windows-x86_64.exe</span><span class="hl-1"> -OutFile \Windows\System32\</span><span class="hl-0">purl.exe</span>
</code></pre>
<p>You can find binaries for more operating systems and architectures on <a href="https://github.com/pojntfx/panrpc/releases">GitHub releases</a>.</p>

<a href="#tutorial" id="tutorial" style="color: inherit; text-decoration: none;">
  <h2>Tutorial</h2>
</a>

<a href="#-go" id="-go" style="color: inherit; text-decoration: none;">
  <h3><img alt="Go" src="https://cdn.simpleicons.org/go" style="vertical-align: middle;" height="20" width="20" /> Go</h3>
</a>
<blockquote>
<p>Just looking for sample code? Check out the sources for the example <a href="./go/cmd/panrpc-example-websocket-coffee-server-cli/main.go">coffee machine server</a> and <a href="./go/cmd/panrpc-example-websocket-coffee-client-cli/main.go">coffee machine client/remote control</a>.</p>
</blockquote>

<a href="#1-choosing-a-transport-and-serializer" id="1-choosing-a-transport-and-serializer" style="color: inherit; text-decoration: none;">
  <h4>1. Choosing a Transport and Serializer</h4>
</a>
<details>
  <summary>Expand section</summary>

<p>Start by creating a new Go module for the tutorial and installing <code>github.com/pojntfx/panrpc/go</code>:</p>
<pre><code class="language-shell"><span class="hl-0">$</span><span class="hl-1"> </span><span class="hl-2">mkdir</span><span class="hl-1"> </span><span class="hl-3">-p</span><span class="hl-1"> </span><span class="hl-2">panrpc-tutorial-go</span><br/><span class="hl-0">$</span><span class="hl-1"> </span><span class="hl-2">cd</span><span class="hl-1"> </span><span class="hl-2">panrpc-tutorial-go</span><br/><span class="hl-0">$</span><span class="hl-1"> </span><span class="hl-2">go</span><span class="hl-1"> </span><span class="hl-2">mod</span><span class="hl-1"> </span><span class="hl-2">init</span><span class="hl-1"> </span><span class="hl-2">panrpc-tutorial-go</span><br/><span class="hl-0">$</span><span class="hl-1"> </span><span class="hl-2">go</span><span class="hl-1"> </span><span class="hl-2">get</span><span class="hl-1"> </span><span class="hl-2">github.com/pojntfx/panrpc/go@latest</span>
</code></pre>
<p>The TypeScript version of panrpc supports many transports. While common ones are TCP, WebSockets, UNIX sockets or WebRTC, anything that directly implements or can be adapted to a <a href="https://pkg.go.dev/io#ReadWriter"><code>io.ReadWriter</code></a> can be used with the panrpc <a href="https://pkg.go.dev/github.com/pojntfx/panrpc/go/pkg/rpc#Registry.LinkStream"><code>LinkStream</code> API</a>. If you want to use a message broker like Redis or NATS as the transport, or need more control over the wire protocol, you can use the <a href="https://pkg.go.dev/github.com/pojntfx/panrpc/go/pkg/rpc#Registry.LinkMessage"><code>LinkMessage</code> API</a> instead. For this tutorial, we&#39;ll be using WebSockets as the transport through the <code>nhooyr.io/websocket</code> library, which you can install like so:</p>
<pre><code class="language-shell"><span class="hl-0">$</span><span class="hl-1"> </span><span class="hl-2">go</span><span class="hl-1"> </span><span class="hl-2">get</span><span class="hl-1"> </span><span class="hl-2">nhooyr.io/websocket@latest</span>
</code></pre>
<p>In addition to supporting many transports, the TypeScript version of panrpc also supports different serializers. Common ones are JSON and CBOR, but similarly to transports anything that implements or can be adapted to a <code>io.ReadWriter</code> stream can be used. For this tutorial, we&#39;ll be using JSON as the serializer through the <code>encoding/json</code> Go standard library.</p>
</details>


<a href="#2-creating-a-server" id="2-creating-a-server" style="color: inherit; text-decoration: none;">
  <h4>2. Creating a Server</h4>
</a>
<p>In this tutorial we&#39;ll be creating a simple coffee machine server that simulates brewing coffee, and can be controlled by using a remote control (the coffee machine client).</p>
<details>
  <summary>Expand section</summary>

<p>To start with implementing the coffee machine server, create a new file <code>cmd/coffee-machine/main.go</code> and define a basic struct with a <code>BrewCoffee</code> method. This method simulates brewing coffee by validating the coffee variant, checking if there is enough water available to brew the coffee, sleeping for five seconds, and returning the new water level to the remote control:</p>
<pre><code class="language-go"><span class="hl-4">// cmd/coffee-machine/main.go</span><br/><br/><span class="hl-3">package</span><span class="hl-1"> main</span><br/><br/><span class="hl-3">import</span><span class="hl-1"> (</span><br/><span class="hl-1">    </span><span class="hl-2">&quot;context&quot;</span><br/><span class="hl-1">    </span><span class="hl-2">&quot;errors&quot;</span><br/><span class="hl-1">    </span><span class="hl-2">&quot;log&quot;</span><br/><span class="hl-1">    </span><span class="hl-2">&quot;slices&quot;</span><br/><span class="hl-1">    </span><span class="hl-2">&quot;time&quot;</span><br/><span class="hl-1">)</span><br/><br/><span class="hl-3">type</span><span class="hl-1"> </span><span class="hl-5">coffeeMachine</span><span class="hl-1"> </span><span class="hl-3">struct</span><span class="hl-1"> {</span><br/><span class="hl-1">    supportedVariants []</span><span class="hl-5">string</span><br/><span class="hl-1">    waterLevel        </span><span class="hl-5">int</span><br/><span class="hl-1">}</span><br/><br/><span class="hl-3">func</span><span class="hl-1"> (s *coffeeMachine) </span><span class="hl-0">BrewCoffee</span><span class="hl-1">(</span><br/><span class="hl-1">    ctx context.Context,</span><br/><span class="hl-1">    variant </span><span class="hl-5">string</span><span class="hl-1">,</span><br/><span class="hl-1">    size </span><span class="hl-5">int</span><span class="hl-1">,</span><br/><span class="hl-1">) (</span><span class="hl-5">int</span><span class="hl-1">, </span><span class="hl-5">error</span><span class="hl-1">) {</span><br/><span class="hl-1">    </span><span class="hl-6">if</span><span class="hl-1"> !slices.</span><span class="hl-0">Contains</span><span class="hl-1">(s.supportedVariants, variant) {</span><br/><span class="hl-1">        </span><span class="hl-6">return</span><span class="hl-1"> </span><span class="hl-7">0</span><span class="hl-1">, errors.</span><span class="hl-0">New</span><span class="hl-1">(</span><span class="hl-2">&quot;unsupported variant&quot;</span><span class="hl-1">)</span><br/><span class="hl-1">    }</span><br/><br/><span class="hl-1">    </span><span class="hl-6">if</span><span class="hl-1"> s.waterLevel-size &lt; </span><span class="hl-7">0</span><span class="hl-1"> {</span><br/><span class="hl-1">        </span><span class="hl-6">return</span><span class="hl-1"> </span><span class="hl-7">0</span><span class="hl-1">, errors.</span><span class="hl-0">New</span><span class="hl-1">(</span><span class="hl-2">&quot;not enough water&quot;</span><span class="hl-1">)</span><br/><span class="hl-1">    }</span><br/><br/><span class="hl-1">    log.</span><span class="hl-0">Println</span><span class="hl-1">(</span><span class="hl-2">&quot;Brewing coffee variant&quot;</span><span class="hl-1">, variant, </span><span class="hl-2">&quot;in size&quot;</span><span class="hl-1">, size, </span><span class="hl-2">&quot;ml&quot;</span><span class="hl-1">)</span><br/><br/><span class="hl-1">    time.</span><span class="hl-0">Sleep</span><span class="hl-1">(time.Second * </span><span class="hl-7">5</span><span class="hl-1">)</span><br/><br/><span class="hl-1">    s.waterLevel -= size</span><br/><br/><span class="hl-1">    </span><span class="hl-6">return</span><span class="hl-1"> s.waterLevel, </span><span class="hl-3">nil</span><br/><span class="hl-1">}</span>
</code></pre>
<blockquote>
<p>The following limitations on which methods can be exposed as RPCs exist:</p>
<ul>
<li>Methods must have <code>context.Context</code> as their first argument</li>
<li>Methods can not have variadic arguments</li>
<li>Methods must return either an error or a single value and an error</li>
</ul>
</blockquote>
<p>To start turning the <code>BrewCoffee</code> method into an RPC, create an instance of the struct and pass it to a <a href="https://pkg.go.dev/github.com/pojntfx/panrpc/go/pkg/rpc#Registry">panrpc Registry</a> like so:</p>
<pre><code class="language-go"><span class="hl-4">// cmd/coffee-machine/main.go</span><br/><br/><span class="hl-3">import</span><span class="hl-1"> </span><span class="hl-2">&quot;github.com/pojntfx/panrpc/go/pkg/rpc&quot;</span><br/><br/><span class="hl-3">func</span><span class="hl-1"> </span><span class="hl-0">main</span><span class="hl-1">() {</span><br/><span class="hl-1">    </span><span class="hl-8">ctx</span><span class="hl-1">, </span><span class="hl-8">cancel</span><span class="hl-1"> := context.</span><span class="hl-0">WithCancel</span><span class="hl-1">(context.</span><span class="hl-0">Background</span><span class="hl-1">())</span><br/><span class="hl-1">    </span><span class="hl-6">defer</span><span class="hl-1"> </span><span class="hl-0">cancel</span><span class="hl-1">()</span><br/><br/><span class="hl-1">    </span><span class="hl-8">service</span><span class="hl-1"> := &amp;coffeeMachine{</span><br/><span class="hl-1">        supportedVariants: []</span><span class="hl-5">string</span><span class="hl-1">{</span><span class="hl-2">&quot;latte&quot;</span><span class="hl-1">, </span><span class="hl-2">&quot;americano&quot;</span><span class="hl-1">},</span><br/><span class="hl-1">        waterLevel:        </span><span class="hl-7">1000</span><span class="hl-1">,</span><br/><span class="hl-1">    }</span><br/><br/><span class="hl-1">    </span><span class="hl-8">clients</span><span class="hl-1"> := </span><span class="hl-7">0</span><br/><br/><span class="hl-1">    </span><span class="hl-8">registry</span><span class="hl-1"> := rpc.NewRegistry[</span><span class="hl-3">struct</span><span class="hl-1">{}, json.RawMessage](</span><br/><span class="hl-1">        service,</span><br/><br/><span class="hl-1">        ctx,</span><br/><br/><span class="hl-1">        &amp;rpc.Options{</span><br/><span class="hl-1">            OnClientConnect: </span><span class="hl-3">func</span><span class="hl-1">(remoteID </span><span class="hl-5">string</span><span class="hl-1">) {</span><br/><span class="hl-1">                clients++</span><br/><br/><span class="hl-1">                log.</span><span class="hl-0">Printf</span><span class="hl-1">(</span><span class="hl-2">&quot;</span><span class="hl-8">%v</span><span class="hl-2"> remote controls connected&quot;</span><span class="hl-1">, clients)</span><br/><span class="hl-1">            },</span><br/><span class="hl-1">            OnClientDisconnect: </span><span class="hl-3">func</span><span class="hl-1">(remoteID </span><span class="hl-5">string</span><span class="hl-1">) {</span><br/><span class="hl-1">                clients--</span><br/><br/><span class="hl-1">                log.</span><span class="hl-0">Printf</span><span class="hl-1">(</span><span class="hl-2">&quot;</span><span class="hl-8">%v</span><span class="hl-2"> remote controls connected&quot;</span><span class="hl-1">, clients)</span><br/><span class="hl-1">            },</span><br/><span class="hl-1">        },</span><br/><span class="hl-1">    )</span><br/><span class="hl-1">}</span>
</code></pre>
<p>Now that we have a registry that provides our coffee machine&#39;s RPCs, we can link it to our transport (WebSockets) and serializer of choice (JSON). This requires a bit of boilerplate to upgrade from HTTP to WebSockets, so feel free to copy-and-paste this:</p>
<details>
  <summary>Expand boilerplate code snippet</summary>

<pre><code class="language-go"><span class="hl-4">// cmd/coffee-machine/main.go</span><br/><br/><span class="hl-3">import</span><span class="hl-1"> (</span><br/><span class="hl-1">    </span><span class="hl-2">&quot;encoding/json&quot;</span><br/><span class="hl-1">    </span><span class="hl-2">&quot;net&quot;</span><br/><span class="hl-1">    </span><span class="hl-2">&quot;net/http&quot;</span><br/><br/><span class="hl-1">    </span><span class="hl-2">&quot;github.com/pojntfx/panrpc/go/pkg/rpc&quot;</span><br/><span class="hl-1">    </span><span class="hl-2">&quot;nhooyr.io/websocket&quot;</span><br/><span class="hl-1">)</span><br/><br/><span class="hl-3">func</span><span class="hl-1"> </span><span class="hl-0">main</span><span class="hl-1">() {</span><br/><span class="hl-1">  </span><span class="hl-4">// ...</span><br/><br/><span class="hl-1">  </span><span class="hl-8">lis</span><span class="hl-1">, </span><span class="hl-8">err</span><span class="hl-1"> := net.</span><span class="hl-0">Listen</span><span class="hl-1">(</span><span class="hl-2">&quot;tcp&quot;</span><span class="hl-1">, </span><span class="hl-2">&quot;127.0.0.1:1337&quot;</span><span class="hl-1">)</span><br/><span class="hl-1">    </span><span class="hl-6">if</span><span class="hl-1"> err != </span><span class="hl-3">nil</span><span class="hl-1"> {</span><br/><span class="hl-1">        </span><span class="hl-0">panic</span><span class="hl-1">(err)</span><br/><span class="hl-1">    }</span><br/><span class="hl-1">    </span><span class="hl-6">defer</span><span class="hl-1"> lis.</span><span class="hl-0">Close</span><span class="hl-1">()</span><br/><br/><span class="hl-1">    log.</span><span class="hl-0">Println</span><span class="hl-1">(</span><span class="hl-2">&quot;Listening on&quot;</span><span class="hl-1">, lis.</span><span class="hl-0">Addr</span><span class="hl-1">())</span><br/><br/><span class="hl-1">    </span><span class="hl-6">if</span><span class="hl-1"> </span><span class="hl-8">err</span><span class="hl-1"> := http.</span><span class="hl-0">Serve</span><span class="hl-1">(lis, http.</span><span class="hl-0">HandlerFunc</span><span class="hl-1">(</span><span class="hl-3">func</span><span class="hl-1">(w http.ResponseWriter, r *http.Request) {</span><br/><span class="hl-1">        </span><span class="hl-6">defer</span><span class="hl-1"> </span><span class="hl-3">func</span><span class="hl-1">() {</span><br/><span class="hl-1">            </span><span class="hl-6">if</span><span class="hl-1"> </span><span class="hl-8">err</span><span class="hl-1"> := </span><span class="hl-0">recover</span><span class="hl-1">(); err != </span><span class="hl-3">nil</span><span class="hl-1"> {</span><br/><span class="hl-1">                w.</span><span class="hl-0">WriteHeader</span><span class="hl-1">(http.StatusInternalServerError)</span><br/><br/><span class="hl-1">                log.</span><span class="hl-0">Printf</span><span class="hl-1">(</span><span class="hl-2">&quot;Remote control disconnected with error: </span><span class="hl-8">%v</span><span class="hl-2">&quot;</span><span class="hl-1">, err)</span><br/><span class="hl-1">            }</span><br/><span class="hl-1">        }()</span><br/><br/><span class="hl-1">        </span><span class="hl-6">switch</span><span class="hl-1"> r.Method {</span><br/><span class="hl-1">        </span><span class="hl-6">case</span><span class="hl-1"> http.MethodGet:</span><br/><span class="hl-1">            </span><span class="hl-8">c</span><span class="hl-1">, </span><span class="hl-8">err</span><span class="hl-1"> := websocket.</span><span class="hl-0">Accept</span><span class="hl-1">(w, r, &amp;websocket.AcceptOptions{</span><br/><span class="hl-1">                OriginPatterns: []</span><span class="hl-5">string</span><span class="hl-1">{</span><span class="hl-2">&quot;*&quot;</span><span class="hl-1">},</span><br/><span class="hl-1">            })</span><br/><span class="hl-1">            </span><span class="hl-6">if</span><span class="hl-1"> err != </span><span class="hl-3">nil</span><span class="hl-1"> {</span><br/><span class="hl-1">                </span><span class="hl-0">panic</span><span class="hl-1">(err)</span><br/><span class="hl-1">            }</span><br/><br/><span class="hl-1">            </span><span class="hl-8">pings</span><span class="hl-1"> := time.</span><span class="hl-0">NewTicker</span><span class="hl-1">(time.Second / </span><span class="hl-7">2</span><span class="hl-1">)</span><br/><span class="hl-1">            </span><span class="hl-6">defer</span><span class="hl-1"> pings.</span><span class="hl-0">Stop</span><span class="hl-1">()</span><br/><br/><span class="hl-1">            </span><span class="hl-8">errs</span><span class="hl-1"> := </span><span class="hl-0">make</span><span class="hl-1">(</span><span class="hl-3">chan</span><span class="hl-1"> </span><span class="hl-5">error</span><span class="hl-1">)</span><br/><span class="hl-1">            </span><span class="hl-6">go</span><span class="hl-1"> </span><span class="hl-3">func</span><span class="hl-1">() {</span><br/><span class="hl-1">                </span><span class="hl-6">for</span><span class="hl-1"> </span><span class="hl-6">range</span><span class="hl-1"> pings.C {</span><br/><span class="hl-1">                    </span><span class="hl-6">if</span><span class="hl-1"> </span><span class="hl-8">err</span><span class="hl-1"> := c.</span><span class="hl-0">Ping</span><span class="hl-1">(ctx); err != </span><span class="hl-3">nil</span><span class="hl-1"> {</span><br/><span class="hl-1">                        errs &lt;- err</span><br/><br/><span class="hl-1">                        </span><span class="hl-6">return</span><br/><span class="hl-1">                    }</span><br/><span class="hl-1">                }</span><br/><span class="hl-1">            }()</span><br/><br/><span class="hl-1">            </span><span class="hl-8">conn</span><span class="hl-1"> := websocket.</span><span class="hl-0">NetConn</span><span class="hl-1">(ctx, c, websocket.MessageText)</span><br/><span class="hl-1">            </span><span class="hl-6">defer</span><span class="hl-1"> conn.</span><span class="hl-0">Close</span><span class="hl-1">()</span><br/><br/><span class="hl-1">            </span><span class="hl-8">encoder</span><span class="hl-1"> := json.</span><span class="hl-0">NewEncoder</span><span class="hl-1">(conn)</span><br/><span class="hl-1">            </span><span class="hl-8">decoder</span><span class="hl-1"> := json.</span><span class="hl-0">NewDecoder</span><span class="hl-1">(conn)</span><br/><br/><span class="hl-1">            </span><span class="hl-6">go</span><span class="hl-1"> </span><span class="hl-3">func</span><span class="hl-1">() {</span><br/><span class="hl-1">                </span><span class="hl-6">if</span><span class="hl-1"> </span><span class="hl-8">err</span><span class="hl-1"> := registry.</span><span class="hl-0">LinkStream</span><span class="hl-1">(</span><br/><span class="hl-1">                    </span><span class="hl-3">func</span><span class="hl-1">(v rpc.Message[json.RawMessage]) </span><span class="hl-5">error</span><span class="hl-1"> {</span><br/><span class="hl-1">                        </span><span class="hl-6">return</span><span class="hl-1"> encoder.</span><span class="hl-0">Encode</span><span class="hl-1">(v)</span><br/><span class="hl-1">                    },</span><br/><span class="hl-1">                    </span><span class="hl-3">func</span><span class="hl-1">(v *rpc.Message[json.RawMessage]) </span><span class="hl-5">error</span><span class="hl-1"> {</span><br/><span class="hl-1">                        </span><span class="hl-6">return</span><span class="hl-1"> decoder.</span><span class="hl-0">Decode</span><span class="hl-1">(v)</span><br/><span class="hl-1">                    },</span><br/><br/><span class="hl-1">                    </span><span class="hl-3">func</span><span class="hl-1">(v any) (json.RawMessage, </span><span class="hl-5">error</span><span class="hl-1">) {</span><br/><span class="hl-1">                        </span><span class="hl-8">b</span><span class="hl-1">, </span><span class="hl-8">err</span><span class="hl-1"> := json.</span><span class="hl-0">Marshal</span><span class="hl-1">(v)</span><br/><span class="hl-1">                        </span><span class="hl-6">if</span><span class="hl-1"> err != </span><span class="hl-3">nil</span><span class="hl-1"> {</span><br/><span class="hl-1">                            </span><span class="hl-6">return</span><span class="hl-1"> </span><span class="hl-3">nil</span><span class="hl-1">, err</span><br/><span class="hl-1">                        }</span><br/><br/><span class="hl-1">                        </span><span class="hl-6">return</span><span class="hl-1"> json.</span><span class="hl-0">RawMessage</span><span class="hl-1">(b), </span><span class="hl-3">nil</span><br/><span class="hl-1">                    },</span><br/><span class="hl-1">                    </span><span class="hl-3">func</span><span class="hl-1">(data json.RawMessage, v any) </span><span class="hl-5">error</span><span class="hl-1"> {</span><br/><span class="hl-1">                        </span><span class="hl-6">return</span><span class="hl-1"> json.</span><span class="hl-0">Unmarshal</span><span class="hl-1">([]</span><span class="hl-0">byte</span><span class="hl-1">(data), v)</span><br/><span class="hl-1">                    },</span><br/><span class="hl-1">                ); err != </span><span class="hl-3">nil</span><span class="hl-1"> {</span><br/><span class="hl-1">                    errs &lt;- err</span><br/><br/><span class="hl-1">                    </span><span class="hl-6">return</span><br/><span class="hl-1">                }</span><br/><span class="hl-1">            }()</span><br/><br/><span class="hl-1">            </span><span class="hl-6">if</span><span class="hl-1"> </span><span class="hl-8">err</span><span class="hl-1"> := &lt;-errs; err != </span><span class="hl-3">nil</span><span class="hl-1"> {</span><br/><span class="hl-1">                </span><span class="hl-0">panic</span><span class="hl-1">(err)</span><br/><span class="hl-1">            }</span><br/><span class="hl-1">        </span><span class="hl-6">default</span><span class="hl-1">:</span><br/><span class="hl-1">            w.</span><span class="hl-0">WriteHeader</span><span class="hl-1">(http.StatusMethodNotAllowed)</span><br/><span class="hl-1">        }</span><br/><span class="hl-1">    })); err != </span><span class="hl-3">nil</span><span class="hl-1"> {</span><br/><span class="hl-1">        </span><span class="hl-0">panic</span><span class="hl-1">(err)</span><br/><span class="hl-1">    }</span><br/><span class="hl-1">}</span>
</code></pre>
</details>

<p><strong>Congratulations!</strong> You&#39;ve created your first panrpc server. You can start it from your terminal like so:</p>
<pre><code class="language-shell"><span class="hl-0">$</span><span class="hl-1"> </span><span class="hl-2">go</span><span class="hl-1"> </span><span class="hl-2">run</span><span class="hl-1"> </span><span class="hl-2">./cmd/coffee-machine/main.go</span>
</code></pre>
<p>You should now see the following in your terminal, which means that the server is available on <code>localhost:1337</code>:</p>
<pre><code class="language-plaintext">Listening on localhost:1337
</code></pre>
</details>


<a href="#3-creating-a-client" id="3-creating-a-client" style="color: inherit; text-decoration: none;">
  <h4>3. Creating a Client</h4>
</a>
<p>In order to interact with the coffee machine server, we&#39;ll now create the remote control (the coffee machine client), which will call the <code>BrewCoffee</code> RPC.</p>
<details>
  <summary>Expand section</summary>

<p>To start with implementing the remote control, create a new file <code>cmd/remote-control/main.go</code> and define a basic struct with a placeholder method that mirrors the <code>BrewCoffee</code> RPC:</p>
<pre><code class="language-go"><span class="hl-4">// cmd/remote-control/main.go</span><br/><br/><span class="hl-3">package</span><span class="hl-1"> main</span><br/><br/><span class="hl-3">import</span><span class="hl-1"> </span><span class="hl-2">&quot;context&quot;</span><br/><br/><span class="hl-3">type</span><span class="hl-1"> </span><span class="hl-5">coffeeMachine</span><span class="hl-1"> </span><span class="hl-3">struct</span><span class="hl-1"> {</span><br/><span class="hl-1">    BrewCoffee </span><span class="hl-3">func</span><span class="hl-1">(</span><br/><span class="hl-1">        ctx context.Context,</span><br/><span class="hl-1">        variant </span><span class="hl-5">string</span><span class="hl-1">,</span><br/><span class="hl-1">        size </span><span class="hl-5">int</span><span class="hl-1">,</span><br/><span class="hl-1">    ) (</span><span class="hl-5">int</span><span class="hl-1">, </span><span class="hl-5">error</span><span class="hl-1">)</span><br/><span class="hl-1">}</span>
</code></pre>
<p>In order to make the <code>BrewCoffee</code> placeholder method do RPC calls, create an instance of the struct and pass it to a <a href="https://pkg.go.dev/github.com/pojntfx/panrpc/go/pkg/rpc#Registry">panrpc Registry</a> like so:</p>
<pre><code class="language-go"><span class="hl-4">// cmd/remote-control/main.go</span><br/><br/><span class="hl-3">import</span><span class="hl-1"> </span><span class="hl-2">&quot;github.com/pojntfx/panrpc/go/pkg/rpc&quot;</span><br/><br/><span class="hl-3">func</span><span class="hl-1"> </span><span class="hl-0">main</span><span class="hl-1">() {</span><br/><span class="hl-1">    </span><span class="hl-8">ctx</span><span class="hl-1">, </span><span class="hl-8">cancel</span><span class="hl-1"> := context.</span><span class="hl-0">WithCancel</span><span class="hl-1">(context.</span><span class="hl-0">Background</span><span class="hl-1">())</span><br/><span class="hl-1">    </span><span class="hl-6">defer</span><span class="hl-1"> </span><span class="hl-0">cancel</span><span class="hl-1">()</span><br/><br/><span class="hl-1">    </span><span class="hl-8">clients</span><span class="hl-1"> := </span><span class="hl-7">0</span><br/><br/><span class="hl-1">    </span><span class="hl-8">registry</span><span class="hl-1"> := rpc.NewRegistry[coffeeMachine, json.RawMessage](</span><br/><span class="hl-1">        &amp;</span><span class="hl-3">struct</span><span class="hl-1">{}{},</span><br/><br/><span class="hl-1">        ctx,</span><br/><br/><span class="hl-1">        &amp;rpc.Options{</span><br/><span class="hl-1">            OnClientConnect: </span><span class="hl-3">func</span><span class="hl-1">(remoteID </span><span class="hl-5">string</span><span class="hl-1">) {</span><br/><span class="hl-1">                clients++</span><br/><br/><span class="hl-1">                log.</span><span class="hl-0">Printf</span><span class="hl-1">(</span><span class="hl-2">&quot;</span><span class="hl-8">%v</span><span class="hl-2"> coffee machines connected&quot;</span><span class="hl-1">, clients)</span><br/><span class="hl-1">            },</span><br/><span class="hl-1">            OnClientDisconnect: </span><span class="hl-3">func</span><span class="hl-1">(remoteID </span><span class="hl-5">string</span><span class="hl-1">) {</span><br/><span class="hl-1">                clients--</span><br/><br/><span class="hl-1">                log.</span><span class="hl-0">Printf</span><span class="hl-1">(</span><span class="hl-2">&quot;</span><span class="hl-8">%v</span><span class="hl-2"> coffee machines connected&quot;</span><span class="hl-1">, clients)</span><br/><span class="hl-1">            },</span><br/><span class="hl-1">        },</span><br/><span class="hl-1">    )</span><br/><span class="hl-1">}</span>
</code></pre>
<p>Now that we have a registry that turns the remote control&#39;s placeholder methods into RPC calls, we can link it to our transport (WebSockets) and serializer of choice (JSON). Once again, this requires a bit of boilerplate to connect to the WebSocket, so feel free to copy-and-paste this:</p>
<details>
  <summary>Expand boilerplate code snippet</summary>

<pre><code class="language-go"><span class="hl-4">// cmd/remote-control/main.go</span><br/><br/><span class="hl-3">import</span><span class="hl-1"> (</span><br/><span class="hl-1">    </span><span class="hl-2">&quot;encoding/json&quot;</span><br/><br/><span class="hl-1">    </span><span class="hl-2">&quot;github.com/pojntfx/panrpc/go/pkg/rpc&quot;</span><br/><span class="hl-1">    </span><span class="hl-2">&quot;nhooyr.io/websocket&quot;</span><br/><span class="hl-1">)</span><br/><br/><span class="hl-3">func</span><span class="hl-1"> </span><span class="hl-0">main</span><span class="hl-1">() {</span><br/><span class="hl-1">  </span><span class="hl-4">// ...</span><br/><br/><span class="hl-1">  </span><span class="hl-8">c</span><span class="hl-1">, </span><span class="hl-8">_</span><span class="hl-1">, </span><span class="hl-8">err</span><span class="hl-1"> := websocket.</span><span class="hl-0">Dial</span><span class="hl-1">(ctx, </span><span class="hl-2">&quot;ws://127.0.0.1:1337&quot;</span><span class="hl-1">, </span><span class="hl-3">nil</span><span class="hl-1">)</span><br/><span class="hl-1">    </span><span class="hl-6">if</span><span class="hl-1"> err != </span><span class="hl-3">nil</span><span class="hl-1"> {</span><br/><span class="hl-1">        </span><span class="hl-0">panic</span><span class="hl-1">(err)</span><br/><span class="hl-1">    }</span><br/><br/><span class="hl-1">    </span><span class="hl-8">conn</span><span class="hl-1"> := websocket.</span><span class="hl-0">NetConn</span><span class="hl-1">(ctx, c, websocket.MessageText)</span><br/><span class="hl-1">    </span><span class="hl-6">defer</span><span class="hl-1"> conn.</span><span class="hl-0">Close</span><span class="hl-1">()</span><br/><br/><span class="hl-1">    log.</span><span class="hl-0">Println</span><span class="hl-1">(</span><span class="hl-2">&quot;Connected to localhost:1337&quot;</span><span class="hl-1">)</span><br/><br/><span class="hl-1">    </span><span class="hl-8">encoder</span><span class="hl-1"> := json.</span><span class="hl-0">NewEncoder</span><span class="hl-1">(conn)</span><br/><span class="hl-1">    </span><span class="hl-8">decoder</span><span class="hl-1"> := json.</span><span class="hl-0">NewDecoder</span><span class="hl-1">(conn)</span><br/><br/><span class="hl-1">    </span><span class="hl-6">if</span><span class="hl-1"> </span><span class="hl-8">err</span><span class="hl-1"> := registry.</span><span class="hl-0">LinkStream</span><span class="hl-1">(</span><br/><span class="hl-1">        </span><span class="hl-3">func</span><span class="hl-1">(v rpc.Message[json.RawMessage]) </span><span class="hl-5">error</span><span class="hl-1"> {</span><br/><span class="hl-1">            </span><span class="hl-6">return</span><span class="hl-1"> encoder.</span><span class="hl-0">Encode</span><span class="hl-1">(v)</span><br/><span class="hl-1">        },</span><br/><span class="hl-1">        </span><span class="hl-3">func</span><span class="hl-1">(v *rpc.Message[json.RawMessage]) </span><span class="hl-5">error</span><span class="hl-1"> {</span><br/><span class="hl-1">            </span><span class="hl-6">return</span><span class="hl-1"> decoder.</span><span class="hl-0">Decode</span><span class="hl-1">(v)</span><br/><span class="hl-1">        },</span><br/><br/><span class="hl-1">        </span><span class="hl-3">func</span><span class="hl-1">(v any) (json.RawMessage, </span><span class="hl-5">error</span><span class="hl-1">) {</span><br/><span class="hl-1">            </span><span class="hl-8">b</span><span class="hl-1">, </span><span class="hl-8">err</span><span class="hl-1"> := json.</span><span class="hl-0">Marshal</span><span class="hl-1">(v)</span><br/><span class="hl-1">            </span><span class="hl-6">if</span><span class="hl-1"> err != </span><span class="hl-3">nil</span><span class="hl-1"> {</span><br/><span class="hl-1">                </span><span class="hl-6">return</span><span class="hl-1"> </span><span class="hl-3">nil</span><span class="hl-1">, err</span><br/><span class="hl-1">            }</span><br/><br/><span class="hl-1">            </span><span class="hl-6">return</span><span class="hl-1"> json.</span><span class="hl-0">RawMessage</span><span class="hl-1">(b), </span><span class="hl-3">nil</span><br/><span class="hl-1">        },</span><br/><span class="hl-1">        </span><span class="hl-3">func</span><span class="hl-1">(data json.RawMessage, v any) </span><span class="hl-5">error</span><span class="hl-1"> {</span><br/><span class="hl-1">            </span><span class="hl-6">return</span><span class="hl-1"> json.</span><span class="hl-0">Unmarshal</span><span class="hl-1">([]</span><span class="hl-0">byte</span><span class="hl-1">(data), v)</span><br/><span class="hl-1">        },</span><br/><span class="hl-1">    ); err != </span><span class="hl-3">nil</span><span class="hl-1"> {</span><br/><span class="hl-1">        </span><span class="hl-0">panic</span><span class="hl-1">(err)</span><br/><span class="hl-1">    }</span><br/><span class="hl-1">}</span>
</code></pre>
</details>

<p><strong>Cheers!</strong> You&#39;ve created your first panrpc client. You can start it from your terminal like so:</p>
<pre><code class="language-shell"><span class="hl-0">$</span><span class="hl-1"> </span><span class="hl-2">go</span><span class="hl-1"> </span><span class="hl-2">run</span><span class="hl-1"> </span><span class="hl-2">./cmd/remote-control/main.go</span>
</code></pre>
<p>You should now see the following in your terminal, which means that the client has connected to the panrpc server at <code>localhost:1337</code>:</p>
<pre><code class="language-plaintext">Connected to localhost:1337
1 coffee machines connected
</code></pre>
<p>Similarly so, the coffee machine server should output the following:</p>
<pre><code class="language-plaintext">1 remote controls connected
</code></pre>
</details>


<a href="#4-calling-the-server39s-rpcs-from-the-client" id="4-calling-the-server39s-rpcs-from-the-client" style="color: inherit; text-decoration: none;">
  <h4>4. Calling the Server&#39;s RPCs from the Client</h4>
</a>
<p>The coffee machine and the client are now connected to each other, but we haven&#39;t added the ability to call the <code>BrewCoffee</code> RPC from the remote control just yet. To fix this, we&#39;ll create a simple TUI interface that will print a list of available coffee variants and sizes to the terminal, waits for the user to make their choice by entering a number, and then calls the <code>BrewCoffee</code> RPC with the correct arguments. After the coffee has been brewed, we&#39;ll print the new water level to the terminal.</p>
<details>
  <summary>Expand section</summary>

<p>To achieve this, we can call this RPC transparently from the remote control by accessing the connected coffee machine(s) with <code>registry.ForRemotes</code>, and we can handle errors by checking with <code>if err := ..., err != nil { ... }</code> just like if we were making a local function call:</p>
<pre><code class="language-go"><span class="hl-4">// cmd/remote-control/main.go</span><br/><br/><span class="hl-3">import</span><span class="hl-1"> (</span><br/><span class="hl-1">    </span><span class="hl-2">&quot;bufio&quot;</span><br/><span class="hl-1">    </span><span class="hl-2">&quot;log&quot;</span><br/><span class="hl-1">    </span><span class="hl-2">&quot;os&quot;</span><br/><span class="hl-1">)</span><br/><br/><span class="hl-3">func</span><span class="hl-1"> </span><span class="hl-0">main</span><span class="hl-1">() {</span><br/><span class="hl-1">  </span><span class="hl-4">// ...</span><br/><br/><span class="hl-1">  </span><span class="hl-6">go</span><span class="hl-1"> </span><span class="hl-3">func</span><span class="hl-1">() {</span><br/><span class="hl-1">        log.</span><span class="hl-0">Println</span><span class="hl-1">(</span><span class="hl-2">`Enter one of the following numbers followed by &lt;ENTER&gt; to brew a coffee:</span><br/><br/><span class="hl-2">- 1: Brew small Cafè Latte</span><br/><span class="hl-2">- 2: Brew large Cafè Latte</span><br/><br/><span class="hl-2">- 3: Brew small Americano</span><br/><span class="hl-2">- 4: Brew large Americano`</span><span class="hl-1">)</span><br/><br/><span class="hl-1">        </span><span class="hl-8">stdin</span><span class="hl-1"> := bufio.</span><span class="hl-0">NewReader</span><span class="hl-1">(os.Stdin)</span><br/><br/><span class="hl-1">        </span><span class="hl-6">for</span><span class="hl-1"> {</span><br/><span class="hl-1">            </span><span class="hl-8">line</span><span class="hl-1">, </span><span class="hl-8">err</span><span class="hl-1"> := stdin.</span><span class="hl-0">ReadString</span><span class="hl-1">(</span><span class="hl-2">&#39;\n&#39;</span><span class="hl-1">)</span><br/><span class="hl-1">            </span><span class="hl-6">if</span><span class="hl-1"> err != </span><span class="hl-3">nil</span><span class="hl-1"> {</span><br/><span class="hl-1">                </span><span class="hl-0">panic</span><span class="hl-1">(err)</span><br/><span class="hl-1">            }</span><br/><br/><span class="hl-1">            </span><span class="hl-6">if</span><span class="hl-1"> </span><span class="hl-8">err</span><span class="hl-1"> := registry.</span><span class="hl-0">ForRemotes</span><span class="hl-1">(</span><span class="hl-3">func</span><span class="hl-1">(remoteID </span><span class="hl-5">string</span><span class="hl-1">, remote coffeeMachine) </span><span class="hl-5">error</span><span class="hl-1"> {</span><br/><span class="hl-1">                </span><span class="hl-6">switch</span><span class="hl-1"> line {</span><br/><span class="hl-1">                </span><span class="hl-6">case</span><span class="hl-1"> </span><span class="hl-2">&quot;1</span><span class="hl-9">\n</span><span class="hl-2">&quot;</span><span class="hl-1">:</span><br/><span class="hl-1">                    </span><span class="hl-6">fallthrough</span><br/><span class="hl-1">                </span><span class="hl-6">case</span><span class="hl-1"> </span><span class="hl-2">&quot;2</span><span class="hl-9">\n</span><span class="hl-2">&quot;</span><span class="hl-1">:</span><br/><span class="hl-1">                    </span><span class="hl-8">res</span><span class="hl-1">, </span><span class="hl-8">err</span><span class="hl-1"> := remote.</span><span class="hl-0">BrewCoffee</span><span class="hl-1">(</span><br/><span class="hl-1">                        ctx,</span><br/><span class="hl-1">                        </span><span class="hl-2">&quot;latte&quot;</span><span class="hl-1">,</span><br/><span class="hl-1">                        </span><span class="hl-3">func</span><span class="hl-1">() </span><span class="hl-5">int</span><span class="hl-1"> {</span><br/><span class="hl-1">                            </span><span class="hl-6">if</span><span class="hl-1"> line == </span><span class="hl-2">&quot;1&quot;</span><span class="hl-1"> {</span><br/><span class="hl-1">                                </span><span class="hl-6">return</span><span class="hl-1"> </span><span class="hl-7">100</span><br/><span class="hl-1">                            } </span><span class="hl-6">else</span><span class="hl-1"> {</span><br/><span class="hl-1">                                </span><span class="hl-6">return</span><span class="hl-1"> </span><span class="hl-7">200</span><br/><span class="hl-1">                            }</span><br/><span class="hl-1">                        }(),</span><br/><span class="hl-1">                    )</span><br/><span class="hl-1">                    </span><span class="hl-6">if</span><span class="hl-1"> err != </span><span class="hl-3">nil</span><span class="hl-1"> {</span><br/><span class="hl-1">                        log.</span><span class="hl-0">Println</span><span class="hl-1">(</span><span class="hl-2">&quot;Couldn&#39;t brew Cafè Latte:&quot;</span><span class="hl-1">, err)</span><br/><br/><span class="hl-1">                        </span><span class="hl-6">return</span><span class="hl-1"> </span><span class="hl-3">nil</span><br/><span class="hl-1">                    }</span><br/><br/><span class="hl-1">                    log.</span><span class="hl-0">Println</span><span class="hl-1">(</span><span class="hl-2">&quot;Remaining water:&quot;</span><span class="hl-1">, res, </span><span class="hl-2">&quot;ml&quot;</span><span class="hl-1">)</span><br/><br/><span class="hl-1">                </span><span class="hl-6">case</span><span class="hl-1"> </span><span class="hl-2">&quot;3</span><span class="hl-9">\n</span><span class="hl-2">&quot;</span><span class="hl-1">:</span><br/><span class="hl-1">                    </span><span class="hl-6">fallthrough</span><br/><span class="hl-1">                </span><span class="hl-6">case</span><span class="hl-1"> </span><span class="hl-2">&quot;4</span><span class="hl-9">\n</span><span class="hl-2">&quot;</span><span class="hl-1">:</span><br/><span class="hl-1">                    </span><span class="hl-8">res</span><span class="hl-1">, </span><span class="hl-8">err</span><span class="hl-1"> := remote.</span><span class="hl-0">BrewCoffee</span><span class="hl-1">(</span><br/><span class="hl-1">                        ctx,</span><br/><span class="hl-1">                        </span><span class="hl-2">&quot;americano&quot;</span><span class="hl-1">,</span><br/><span class="hl-1">                        </span><span class="hl-3">func</span><span class="hl-1">() </span><span class="hl-5">int</span><span class="hl-1"> {</span><br/><span class="hl-1">                            </span><span class="hl-6">if</span><span class="hl-1"> line == </span><span class="hl-2">&quot;1&quot;</span><span class="hl-1"> {</span><br/><span class="hl-1">                                </span><span class="hl-6">return</span><span class="hl-1"> </span><span class="hl-7">100</span><br/><span class="hl-1">                            } </span><span class="hl-6">else</span><span class="hl-1"> {</span><br/><span class="hl-1">                                </span><span class="hl-6">return</span><span class="hl-1"> </span><span class="hl-7">200</span><br/><span class="hl-1">                            }</span><br/><span class="hl-1">                        }(),</span><br/><span class="hl-1">                    )</span><br/><span class="hl-1">                    </span><span class="hl-6">if</span><span class="hl-1"> err != </span><span class="hl-3">nil</span><span class="hl-1"> {</span><br/><span class="hl-1">                        log.</span><span class="hl-0">Println</span><span class="hl-1">(</span><span class="hl-2">&quot;Couldn&#39;t brew Americano:&quot;</span><span class="hl-1">, err)</span><br/><br/><span class="hl-1">                        </span><span class="hl-6">return</span><span class="hl-1"> </span><span class="hl-3">nil</span><br/><span class="hl-1">                    }</span><br/><br/><span class="hl-1">                    log.</span><span class="hl-0">Println</span><span class="hl-1">(</span><span class="hl-2">&quot;Remaining water:&quot;</span><span class="hl-1">, res, </span><span class="hl-2">&quot;ml&quot;</span><span class="hl-1">)</span><br/><br/><span class="hl-1">                </span><span class="hl-6">default</span><span class="hl-1">:</span><br/><span class="hl-1">                    log.</span><span class="hl-0">Printf</span><span class="hl-1">(</span><span class="hl-2">&quot;Unknown letter </span><span class="hl-8">%v</span><span class="hl-2">, ignoring input&quot;</span><span class="hl-1">, line)</span><br/><br/><span class="hl-1">                    </span><span class="hl-6">return</span><span class="hl-1"> </span><span class="hl-3">nil</span><br/><span class="hl-1">                }</span><br/><br/><span class="hl-1">                </span><span class="hl-6">return</span><span class="hl-1"> </span><span class="hl-3">nil</span><br/><span class="hl-1">            }); err != </span><span class="hl-3">nil</span><span class="hl-1"> {</span><br/><span class="hl-1">                </span><span class="hl-0">panic</span><span class="hl-1">(err)</span><br/><span class="hl-1">            }</span><br/><span class="hl-1">        }</span><br/><span class="hl-1">    }()</span><br/><br/><span class="hl-1">  </span><span class="hl-4">// ...</span><br/><span class="hl-1">}</span>
</code></pre>
<blockquote>
<p>Note that by cancelling the <code>context.Context</code> that we pass in as the first argument to every RPC call, you can cancel an RPC call before it has returned, which is useful for <a href="https://pkg.go.dev/context#WithTimeout">implementing things like timeouts</a>. If you don&#39;t cancel this <code>context.Context</code> like we do in this example, the RPC call will simply block until it returns.</p>
</blockquote>
<p>Now we can restart the remote control like so:</p>
<pre><code class="language-shell"><span class="hl-0">$</span><span class="hl-1"> </span><span class="hl-2">go</span><span class="hl-1"> </span><span class="hl-2">run</span><span class="hl-1"> </span><span class="hl-2">./cmd/remote-control/main.go</span>
</code></pre>
<p>After which you should see the following output:</p>
<pre><code class="language-plaintext">Enter one of the following numbers followed by &lt;ENTER&gt; to brew a coffee:

- 1: Brew small Cafè Latte
- 2: Brew large Cafè Latte

- 3: Brew small Americano
- 4: Brew large Americano
1 coffee machines connected
Connected to localhost:1337
</code></pre>
<p>It is now possible to brew a coffee by pressing a number and <kbd>ENTER</kbd>. Once the RPC has been called, the coffee machine should print something like the following:</p>
<pre><code class="language-plaintext">Brewing coffee variant latte in size 100 ml
</code></pre>
<p>And after the coffee has been brewed, the remote control should return the remaining water level like so:</p>
<pre><code class="language-plaintext">Remaining water: 900 ml
</code></pre>
<p><strong>Enjoy your (virtual) coffee!</strong> You&#39;ve successfully called an RPC provided by a server from the client. Feel free to try out the other supported variants and sizes until there is no more water remaining.</p>
</details>


<a href="#5-calling-the-client39s-rpcs-from-the-server" id="5-calling-the-client39s-rpcs-from-the-server" style="color: inherit; text-decoration: none;">
  <h4>5. Calling the Client&#39;s RPCs from the Server</h4>
</a>
<p>So far, we&#39;ve enabled a remote control/client to call the <code>BrewCoffee</code> RPC on the coffee machine/server. This however means that if multiple remote controls are connected to one coffee machine, only the remote control that called the RPC is aware of coffee being brewed. In order to notify the other remote controls that coffee is being brewed, we will use panrpc to call a new RPC on the remote control/client from the coffee machine/server each time we brew coffee.</p>
<details>
  <summary>Expand section</summary>

<p>To get started, we can once again create a basic struct on the client with a method <code>SetCoffeeMachineBrewing</code>, which will print the state of the coffee machine to the remote control&#39;s terminal:</p>
<pre><code class="language-go"><span class="hl-4">// cmd/remote-control/main.go</span><br/><br/><span class="hl-3">type</span><span class="hl-1"> </span><span class="hl-5">remoteControl</span><span class="hl-1"> </span><span class="hl-3">struct</span><span class="hl-1">{}</span><br/><br/><span class="hl-3">func</span><span class="hl-1"> (s *remoteControl) </span><span class="hl-0">SetCoffeeMachineBrewing</span><span class="hl-1">(ctx context.Context, brewing </span><span class="hl-5">bool</span><span class="hl-1">) </span><span class="hl-5">error</span><span class="hl-1"> {</span><br/><span class="hl-1">    </span><span class="hl-6">if</span><span class="hl-1"> brewing {</span><br/><span class="hl-1">        log.</span><span class="hl-0">Println</span><span class="hl-1">(</span><span class="hl-2">&quot;Coffee machine is now brewing&quot;</span><span class="hl-1">)</span><br/><span class="hl-1">    } </span><span class="hl-6">else</span><span class="hl-1"> {</span><br/><span class="hl-1">        log.</span><span class="hl-0">Println</span><span class="hl-1">(</span><span class="hl-2">&quot;Coffee machine has stopped brewing&quot;</span><span class="hl-1">)</span><br/><span class="hl-1">    }</span><br/><br/><span class="hl-1">    </span><span class="hl-6">return</span><span class="hl-1"> </span><span class="hl-3">nil</span><br/><span class="hl-1">}</span>
</code></pre>
<p>To start turning this new <code>SetCoffeeMachineBrewing</code> method into an RPC that server can call, create an instance of the struct and pass it to the client&#39;s registry like so:</p>
<pre><code class="language-go"><span class="hl-4">// cmd/remote-control/main.go</span><br/><br/><span class="hl-3">func</span><span class="hl-1"> </span><span class="hl-0">main</span><span class="hl-1">() {</span><br/><span class="hl-1">  </span><span class="hl-4">// ...</span><br/><br/><span class="hl-1">  </span><span class="hl-8">registry</span><span class="hl-1"> := rpc.NewRegistry[coffeeMachine, json.RawMessage](</span><br/><span class="hl-1">        &amp;remoteControl{},</span><br/><br/><span class="hl-1">        ctx,</span><br/><br/><span class="hl-1">        &amp;rpc.Options{</span><br/><span class="hl-1">            OnClientConnect: </span><span class="hl-3">func</span><span class="hl-1">(remoteID </span><span class="hl-5">string</span><span class="hl-1">) {</span><br/><span class="hl-1">                clients++</span><br/><br/><span class="hl-1">                log.</span><span class="hl-0">Printf</span><span class="hl-1">(</span><span class="hl-2">&quot;</span><span class="hl-8">%v</span><span class="hl-2"> coffee machines connected&quot;</span><span class="hl-1">, clients)</span><br/><span class="hl-1">            },</span><br/><span class="hl-1">            OnClientDisconnect: </span><span class="hl-3">func</span><span class="hl-1">(remoteID </span><span class="hl-5">string</span><span class="hl-1">) {</span><br/><span class="hl-1">                clients--</span><br/><br/><span class="hl-1">                log.</span><span class="hl-0">Printf</span><span class="hl-1">(</span><span class="hl-2">&quot;</span><span class="hl-8">%v</span><span class="hl-2"> coffee machines connected&quot;</span><span class="hl-1">, clients)</span><br/><span class="hl-1">            },</span><br/><span class="hl-1">        },</span><br/><span class="hl-1">    )</span><br/><br/><span class="hl-1">  </span><span class="hl-4">// ...</span><br/><span class="hl-1">}</span>
</code></pre>
<p>The remote control/client now exposes the <code>SetCoffeeMachineBrewing</code> RPC, and we can start enabling the coffee machine/server to call it by defining a basic struct with a method that mirrors the RPC, just like we did before on the remote control for <code>BrewCoffee</code>:</p>
<pre><code class="language-go"><span class="hl-4">// cmd/coffee-machine/main.go</span><br/><br/><span class="hl-3">type</span><span class="hl-1"> </span><span class="hl-5">remoteControl</span><span class="hl-1"> </span><span class="hl-3">struct</span><span class="hl-1"> {</span><br/><span class="hl-1">    SetCoffeeMachineBrewing </span><span class="hl-3">func</span><span class="hl-1">(ctx context.Context, brewing </span><span class="hl-5">bool</span><span class="hl-1">) </span><span class="hl-5">error</span><br/><span class="hl-1">}</span>
</code></pre>
<p>In order to make the <code>SetCoffeeMachineBrewing</code> placeholder method do RPC calls, create an instance of the struct and pass it to the server&#39;s registry like so:</p>
<pre><code class="language-typescript"><span class="hl-4">// cmd/coffee-machine/main.go</span><br/><br/><span class="hl-8">func</span><span class="hl-1"> </span><span class="hl-0">main</span><span class="hl-1">() {</span><br/><span class="hl-1">  </span><span class="hl-4">// ...</span><br/><br/><span class="hl-1">    </span><span class="hl-10">registry</span><span class="hl-1"> := </span><span class="hl-8">rpc</span><span class="hl-1">.</span><span class="hl-8">NewRegistry</span><span class="hl-1">[</span><span class="hl-8">remoteControl</span><span class="hl-1">, </span><span class="hl-8">json</span><span class="hl-1">.</span><span class="hl-8">RawMessage</span><span class="hl-1">](</span><br/><span class="hl-1">        </span><span class="hl-8">service</span><span class="hl-1">,</span><br/><br/><span class="hl-1">        </span><span class="hl-8">ctx</span><span class="hl-1">,</span><br/><br/><span class="hl-1">        &amp;</span><span class="hl-8">rpc</span><span class="hl-1">.</span><span class="hl-8">Options</span><span class="hl-1">{</span><br/><span class="hl-1">            </span><span class="hl-8">OnClientConnect:</span><span class="hl-1"> </span><span class="hl-0">func</span><span class="hl-1">(</span><span class="hl-8">remoteID</span><span class="hl-1"> </span><span class="hl-8">string</span><span class="hl-1">) {</span><br/><span class="hl-1">                clients++</span><br/><br/><span class="hl-1">                log.Printf(</span><span class="hl-2">&quot;%v remote controls connected&quot;</span><span class="hl-1">, clients)</span><br/><span class="hl-1">            },</span><br/><span class="hl-1">            </span><span class="hl-8">OnClientDisconnect:</span><span class="hl-1"> </span><span class="hl-0">func</span><span class="hl-1">(</span><span class="hl-8">remoteID</span><span class="hl-1"> </span><span class="hl-8">string</span><span class="hl-1">) {</span><br/><span class="hl-1">                clients--</span><br/><br/><span class="hl-1">                log.Printf(</span><span class="hl-2">&quot;%v remote controls connected&quot;</span><span class="hl-1">, clients)</span><br/><span class="hl-1">            },</span><br/><span class="hl-1">        },</span><br/><span class="hl-1">    )</span><br/><br/><span class="hl-1">  </span><span class="hl-4">// ...</span><br/><span class="hl-1">}</span>
</code></pre>
<p>The coffee machine/server and the remote control/client now both know of the new <code>SetCoffeeMachineBrewing</code> RPC, but the server doesn&#39;t call it yet. To fix this, we can call this RPC transparently from the coffee machine by accessing the connected remote control(s) with <code>registry.ForRemotes</code> just like we did before in the remote control, and we can handle errors by checking with <code>if err := ..., err != nil { ... }</code> just like if we were making a local function call. We&#39;ll also use the first argument to the RPC, <code>ctx</code>, in conjunction with <code>rpc.GetRemoteID</code> to get the ID of the remote control/client that is calling <code>BrewCoffee</code>, so that we don&#39;t call <code>SetCoffeeMachineBrewing</code> on the remote control/client that is calling <code>BrewCoffee</code> itself:</p>
<pre><code class="language-go"><span class="hl-4">// cmd/remote-control/main.go</span><br/><br/><span class="hl-3">type</span><span class="hl-1"> </span><span class="hl-5">coffeeMachine</span><span class="hl-1"> </span><span class="hl-3">struct</span><span class="hl-1"> {</span><br/><span class="hl-1">    supportedVariants []</span><span class="hl-5">string</span><br/><span class="hl-1">    waterLevel        </span><span class="hl-5">int</span><br/><br/><span class="hl-1">    ForRemotes </span><span class="hl-3">func</span><span class="hl-1">(</span><br/><span class="hl-1">        cb </span><span class="hl-3">func</span><span class="hl-1">(remoteID </span><span class="hl-5">string</span><span class="hl-1">, remote remoteControl) </span><span class="hl-5">error</span><span class="hl-1">,</span><br/><span class="hl-1">    ) </span><span class="hl-5">error</span><br/><span class="hl-1">}</span><br/><br/><span class="hl-3">func</span><span class="hl-1"> (s *coffeeMachine) </span><span class="hl-0">BrewCoffee</span><span class="hl-1">(</span><br/><span class="hl-1">    ctx context.Context,</span><br/><span class="hl-1">    variant </span><span class="hl-5">string</span><span class="hl-1">,</span><br/><span class="hl-1">    size </span><span class="hl-5">int</span><span class="hl-1">,</span><br/><span class="hl-1">) (</span><span class="hl-5">int</span><span class="hl-1">, </span><span class="hl-5">error</span><span class="hl-1">) {</span><br/><span class="hl-1">  </span><span class="hl-4">// Get the ID of the remote control that&#39;s calling `BrewCoffee`</span><br/><span class="hl-1">    </span><span class="hl-8">targetID</span><span class="hl-1"> := rpc.</span><span class="hl-0">GetRemoteID</span><span class="hl-1">(ctx)</span><br/><br/><span class="hl-1">  </span><span class="hl-4">// Notify connected remote controls that coffee is no longer brewing</span><br/><span class="hl-1">    </span><span class="hl-6">defer</span><span class="hl-1"> s.</span><span class="hl-0">ForRemotes</span><span class="hl-1">(</span><span class="hl-3">func</span><span class="hl-1">(remoteID </span><span class="hl-5">string</span><span class="hl-1">, remote remoteControl) </span><span class="hl-5">error</span><span class="hl-1"> {</span><br/><span class="hl-1">    </span><span class="hl-4">// Don&#39;t call `SetCoffeeMachineBrewing` if it&#39;s the remote control that&#39;s calling `BrewCoffee`</span><br/><span class="hl-1">        </span><span class="hl-6">if</span><span class="hl-1"> remoteID == targetID {</span><br/><span class="hl-1">            </span><span class="hl-6">return</span><span class="hl-1"> </span><span class="hl-3">nil</span><br/><span class="hl-1">        }</span><br/><br/><span class="hl-1">        </span><span class="hl-6">return</span><span class="hl-1"> remote.</span><span class="hl-0">SetCoffeeMachineBrewing</span><span class="hl-1">(ctx, </span><span class="hl-3">false</span><span class="hl-1">)</span><br/><span class="hl-1">    })</span><br/><br/><span class="hl-1">  </span><span class="hl-4">// Notify connected remote controls that coffee is brewing</span><br/><span class="hl-1">    </span><span class="hl-6">if</span><span class="hl-1"> </span><span class="hl-8">err</span><span class="hl-1"> := s.</span><span class="hl-0">ForRemotes</span><span class="hl-1">(</span><span class="hl-3">func</span><span class="hl-1">(remoteID </span><span class="hl-5">string</span><span class="hl-1">, remote remoteControl) </span><span class="hl-5">error</span><span class="hl-1"> {</span><br/><span class="hl-1">    </span><span class="hl-4">// Don&#39;t call `SetCoffeeMachineBrewing` if it&#39;s the remote control that&#39;s calling `BrewCoffee`</span><br/><span class="hl-1">        </span><span class="hl-6">if</span><span class="hl-1"> remoteID == targetID {</span><br/><span class="hl-1">            </span><span class="hl-6">return</span><span class="hl-1"> </span><span class="hl-3">nil</span><br/><span class="hl-1">        }</span><br/><br/><span class="hl-1">        </span><span class="hl-6">return</span><span class="hl-1"> remote.</span><span class="hl-0">SetCoffeeMachineBrewing</span><span class="hl-1">(ctx, </span><span class="hl-3">true</span><span class="hl-1">)</span><br/><span class="hl-1">    }); err != </span><span class="hl-3">nil</span><span class="hl-1"> {</span><br/><span class="hl-1">        </span><span class="hl-6">return</span><span class="hl-1"> </span><span class="hl-7">0</span><span class="hl-1">, err</span><br/><span class="hl-1">    }</span><br/><br/><span class="hl-1">    </span><span class="hl-6">if</span><span class="hl-1"> !slices.</span><span class="hl-0">Contains</span><span class="hl-1">(s.supportedVariants, variant) {</span><br/><span class="hl-1">        </span><span class="hl-6">return</span><span class="hl-1"> </span><span class="hl-7">0</span><span class="hl-1">, errors.</span><span class="hl-0">New</span><span class="hl-1">(</span><span class="hl-2">&quot;unsupported variant&quot;</span><span class="hl-1">)</span><br/><span class="hl-1">    }</span><br/><br/><span class="hl-1">    </span><span class="hl-6">if</span><span class="hl-1"> s.waterLevel-size &lt; </span><span class="hl-7">0</span><span class="hl-1"> {</span><br/><span class="hl-1">        </span><span class="hl-6">return</span><span class="hl-1"> </span><span class="hl-7">0</span><span class="hl-1">, errors.</span><span class="hl-0">New</span><span class="hl-1">(</span><span class="hl-2">&quot;not enough water&quot;</span><span class="hl-1">)</span><br/><span class="hl-1">    }</span><br/><br/><span class="hl-1">    log.</span><span class="hl-0">Println</span><span class="hl-1">(</span><span class="hl-2">&quot;Brewing coffee variant&quot;</span><span class="hl-1">, variant, </span><span class="hl-2">&quot;in size&quot;</span><span class="hl-1">, size, </span><span class="hl-2">&quot;ml&quot;</span><span class="hl-1">)</span><br/><br/><span class="hl-1">    time.</span><span class="hl-0">Sleep</span><span class="hl-1">(time.Second * </span><span class="hl-7">5</span><span class="hl-1">)</span><br/><br/><span class="hl-1">    s.waterLevel -= size</span><br/><br/><span class="hl-1">    </span><span class="hl-6">return</span><span class="hl-1"> s.waterLevel, </span><span class="hl-3">nil</span><br/><span class="hl-1">}</span>
</code></pre>
<p>Note that we&#39;ve added the <code>forRemotes</code> field to the coffee machine/server; we can get the implementation for it from the registry like so:</p>
<pre><code class="language-go"><span class="hl-4">// cmd/coffee-machine/main.go</span><br/><br/><span class="hl-3">func</span><span class="hl-1"> main{</span><br/><span class="hl-1">  </span><span class="hl-8">service</span><span class="hl-1"> := </span><span class="hl-4">// ...</span><br/><br/><span class="hl-1">  </span><span class="hl-8">registry</span><span class="hl-1"> := </span><span class="hl-4">// ...</span><br/><span class="hl-1">  </span><span class="hl-8">service.forRemotes</span><span class="hl-1"> = registry.ForRemotes;</span><br/><span class="hl-1">}</span>
</code></pre>
<p>Now that we&#39;ve added support for this RPC to the coffee machine/server, we can restart it like so:</p>
<pre><code class="language-shell"><span class="hl-0">$</span><span class="hl-1"> </span><span class="hl-2">go</span><span class="hl-1"> </span><span class="hl-2">run</span><span class="hl-1"> </span><span class="hl-2">./cmd/coffee-machine/main.go</span>
</code></pre>
<p>To test if it works, connect two remote controls/clients to it like so:</p>
<pre><code class="language-shell"><span class="hl-0">$</span><span class="hl-1"> </span><span class="hl-2">go</span><span class="hl-1"> </span><span class="hl-2">run</span><span class="hl-1"> </span><span class="hl-2">./cmd/remote-control/main.go</span><br/><span class="hl-4"># In another terminal</span><br/><span class="hl-0">$</span><span class="hl-1"> </span><span class="hl-2">go</span><span class="hl-1"> </span><span class="hl-2">run</span><span class="hl-1"> </span><span class="hl-2">./cmd/remote-control/main.go</span>
</code></pre>
<p>You can now request the coffee machine to brew a coffee on either of the remote controls by pressing a number and <kbd>ENTER</kbd>. Once the RPC has been called, the coffee machine should print something like the following again:</p>
<pre><code class="language-plaintext">Brewing coffee variant latte in size 100 ml
</code></pre>
<p>And after the coffee has been brewed, the remote control that you&#39;ve chosen to brew the coffee with should once again return the remaining water level like so:</p>
<pre><code class="language-plaintext">Remaining water: 900 ml
</code></pre>
<p>The other connected remote controls will be notified that the coffee machine is brewing, and then once it has finished brewing:</p>
<pre><code class="language-plaintext">Coffee machine is now brewing
Coffee machine has stopped brewing
</code></pre>
<p><strong>Enjoy your distributed coffee machine!</strong> You&#39;ve successfully called an RPC provided by a client from the server to implement multicast notifications, something that usually is quite complex to do with RPC systems.</p>
</details>


<a href="#6-passing-closures-to-rpcs" id="6-passing-closures-to-rpcs" style="color: inherit; text-decoration: none;">
  <h4>6. Passing Closures to RPCs</h4>
</a>
<p>So far, when the remote control/client calls the <code>BrewCoffee</code> RPC, there is no way of knowing the incremental progress of the brew other than waiting for <code>BrewCoffee</code> to return the new water level. In order to know of the progress of the coffee machine as it is brewing, we can make use of the closure/callback support in panrpc, which allows us to pass a function to an RPC call, just like you could do locally.</p>
<details>
  <summary>Expand section</summary>

<p>First, we&#39;ll add a <code>onProgress</code> callback to the coffee machine&#39;s <code>BrewCoffee</code> implementation, which we then call incrementally during the brewing process:</p>
<pre><code class="language-go"><span class="hl-4">// cmd/coffee-machine/main.go</span><br/><br/><span class="hl-3">func</span><span class="hl-1"> (s *coffeeMachine) </span><span class="hl-0">BrewCoffee</span><span class="hl-1">(</span><br/><span class="hl-1">    ctx context.Context,</span><br/><span class="hl-1">    variant </span><span class="hl-5">string</span><span class="hl-1">,</span><br/><span class="hl-1">    size </span><span class="hl-5">int</span><span class="hl-1">,</span><br/><span class="hl-1">    onProgress </span><span class="hl-3">func</span><span class="hl-1">(ctx context.Context, percentage </span><span class="hl-5">int</span><span class="hl-1">) </span><span class="hl-5">error</span><span class="hl-1">, </span><span class="hl-4">// This is new</span><br/><span class="hl-1">) (</span><span class="hl-5">int</span><span class="hl-1">, </span><span class="hl-5">error</span><span class="hl-1">) {</span><br/><span class="hl-1">    </span><span class="hl-4">// ...</span><br/><br/><span class="hl-1">    </span><span class="hl-4">// Report 0% brewing process</span><br/><span class="hl-1">    </span><span class="hl-6">if</span><span class="hl-1"> </span><span class="hl-8">err</span><span class="hl-1"> := </span><span class="hl-0">onProgress</span><span class="hl-1">(ctx, </span><span class="hl-7">0</span><span class="hl-1">); err != </span><span class="hl-3">nil</span><span class="hl-1"> {</span><br/><span class="hl-1">        </span><span class="hl-6">return</span><span class="hl-1"> </span><span class="hl-7">0</span><span class="hl-1">, err</span><br/><span class="hl-1">    }</span><br/><br/><span class="hl-1">    </span><span class="hl-4">// Report 25% brewing process</span><br/><span class="hl-1">    time.</span><span class="hl-0">Sleep</span><span class="hl-1">(</span><span class="hl-7">500</span><span class="hl-1"> * time.Millisecond)</span><br/><span class="hl-1">    </span><span class="hl-6">if</span><span class="hl-1"> </span><span class="hl-8">err</span><span class="hl-1"> := </span><span class="hl-0">onProgress</span><span class="hl-1">(ctx, </span><span class="hl-7">25</span><span class="hl-1">); err != </span><span class="hl-3">nil</span><span class="hl-1"> {</span><br/><span class="hl-1">        </span><span class="hl-6">return</span><span class="hl-1"> </span><span class="hl-7">0</span><span class="hl-1">, err</span><br/><span class="hl-1">    }</span><br/><br/><span class="hl-1">    </span><span class="hl-4">// Report 50% brewing process</span><br/><span class="hl-1">    time.</span><span class="hl-0">Sleep</span><span class="hl-1">(</span><span class="hl-7">500</span><span class="hl-1"> * time.Millisecond)</span><br/><span class="hl-1">    </span><span class="hl-6">if</span><span class="hl-1"> </span><span class="hl-8">err</span><span class="hl-1"> := </span><span class="hl-0">onProgress</span><span class="hl-1">(ctx, </span><span class="hl-7">50</span><span class="hl-1">); err != </span><span class="hl-3">nil</span><span class="hl-1"> {</span><br/><span class="hl-1">        </span><span class="hl-6">return</span><span class="hl-1"> </span><span class="hl-7">0</span><span class="hl-1">, err</span><br/><span class="hl-1">    }</span><br/><br/><span class="hl-1">    </span><span class="hl-4">// Report 75% brewing process</span><br/><span class="hl-1">    time.</span><span class="hl-0">Sleep</span><span class="hl-1">(</span><span class="hl-7">500</span><span class="hl-1"> * time.Millisecond)</span><br/><span class="hl-1">    </span><span class="hl-6">if</span><span class="hl-1"> </span><span class="hl-8">err</span><span class="hl-1"> := </span><span class="hl-0">onProgress</span><span class="hl-1">(ctx, </span><span class="hl-7">75</span><span class="hl-1">); err != </span><span class="hl-3">nil</span><span class="hl-1"> {</span><br/><span class="hl-1">        </span><span class="hl-6">return</span><span class="hl-1"> </span><span class="hl-7">0</span><span class="hl-1">, err</span><br/><span class="hl-1">    }</span><br/><br/><span class="hl-1">    </span><span class="hl-4">// Report 100% brewing process</span><br/><span class="hl-1">    time.</span><span class="hl-0">Sleep</span><span class="hl-1">(</span><span class="hl-7">500</span><span class="hl-1"> * time.Millisecond)</span><br/><span class="hl-1">    </span><span class="hl-6">if</span><span class="hl-1"> </span><span class="hl-8">err</span><span class="hl-1"> := </span><span class="hl-0">onProgress</span><span class="hl-1">(ctx, </span><span class="hl-7">100</span><span class="hl-1">); err != </span><span class="hl-3">nil</span><span class="hl-1"> {</span><br/><span class="hl-1">        </span><span class="hl-6">return</span><span class="hl-1"> </span><span class="hl-7">0</span><span class="hl-1">, err</span><br/><span class="hl-1">    }</span><br/><br/><span class="hl-1">    </span><span class="hl-4">// ..</span><br/><br/><span class="hl-1">    </span><span class="hl-6">return</span><span class="hl-1"> s.waterLevel, </span><span class="hl-3">nil</span><br/><span class="hl-1">}</span>
</code></pre>
<p>In the remote control, we&#39;ll also extend the struct with the <code>BrewCoffee</code> placeholder method with this new RPC argument:</p>
<pre><code class="language-go"><span class="hl-4">// cmd/remote-control/main.go</span><br/><br/><span class="hl-3">type</span><span class="hl-1"> </span><span class="hl-5">coffeeMachine</span><span class="hl-1"> </span><span class="hl-3">struct</span><span class="hl-1"> {</span><br/><span class="hl-1">    BrewCoffee </span><span class="hl-3">func</span><span class="hl-1">(</span><br/><span class="hl-1">        ctx context.Context,</span><br/><span class="hl-1">        variant </span><span class="hl-5">string</span><span class="hl-1">,</span><br/><span class="hl-1">        size </span><span class="hl-5">int</span><span class="hl-1">,</span><br/><span class="hl-1">        onProgress </span><span class="hl-3">func</span><span class="hl-1">(ctx context.Context, percentage </span><span class="hl-5">int</span><span class="hl-1">) </span><span class="hl-5">error</span><span class="hl-1">, </span><span class="hl-4">// This is new</span><br/><span class="hl-1">    ) (</span><span class="hl-5">int</span><span class="hl-1">, </span><span class="hl-5">error</span><span class="hl-1">)</span><br/><span class="hl-1">}</span>
</code></pre>
<p>And finally, where we call the <code>BrewCoffee</code> RPC in the remote control/client, we can pass in the implementation of this closure:</p>
<pre><code class="language-go"><span class="hl-4">// cmd/remote-control/main.go</span><br/><br/><span class="hl-6">go</span><span class="hl-1"> </span><span class="hl-3">func</span><span class="hl-1">() {</span><br/><span class="hl-1">    </span><span class="hl-4">// ...</span><br/><span class="hl-1">    </span><span class="hl-6">for</span><span class="hl-1"> {</span><br/><span class="hl-1">        </span><span class="hl-4">// ...</span><br/><span class="hl-1">        </span><span class="hl-6">if</span><span class="hl-1"> </span><span class="hl-8">err</span><span class="hl-1"> := registry.</span><span class="hl-0">ForRemotes</span><span class="hl-1">(</span><span class="hl-3">func</span><span class="hl-1">(remoteID </span><span class="hl-5">string</span><span class="hl-1">, remote coffeeMachine) </span><span class="hl-5">error</span><span class="hl-1"> {</span><br/><span class="hl-1">            </span><span class="hl-6">switch</span><span class="hl-1"> line {</span><br/><span class="hl-1">            </span><span class="hl-6">case</span><span class="hl-1"> </span><span class="hl-2">&quot;1</span><span class="hl-9">\n</span><span class="hl-2">&quot;</span><span class="hl-1">:</span><br/><span class="hl-1">                </span><span class="hl-6">fallthrough</span><br/><span class="hl-1">            </span><span class="hl-6">case</span><span class="hl-1"> </span><span class="hl-2">&quot;2</span><span class="hl-9">\n</span><span class="hl-2">&quot;</span><span class="hl-1">:</span><br/><span class="hl-1">                </span><span class="hl-8">res</span><span class="hl-1">, </span><span class="hl-8">err</span><span class="hl-1"> := remote.</span><span class="hl-0">BrewCoffee</span><span class="hl-1">(</span><br/><span class="hl-1">                    ctx,</span><br/><span class="hl-1">                    </span><span class="hl-2">&quot;latte&quot;</span><span class="hl-1">,</span><br/><span class="hl-1">                    </span><span class="hl-3">func</span><span class="hl-1">() </span><span class="hl-5">int</span><span class="hl-1"> {</span><br/><span class="hl-1">                        </span><span class="hl-6">if</span><span class="hl-1"> line == </span><span class="hl-2">&quot;1&quot;</span><span class="hl-1"> {</span><br/><span class="hl-1">                            </span><span class="hl-6">return</span><span class="hl-1"> </span><span class="hl-7">100</span><br/><span class="hl-1">                        } </span><span class="hl-6">else</span><span class="hl-1"> {</span><br/><span class="hl-1">                            </span><span class="hl-6">return</span><span class="hl-1"> </span><span class="hl-7">200</span><br/><span class="hl-1">                        }</span><br/><span class="hl-1">                    }(),</span><br/><span class="hl-1">                    </span><span class="hl-3">func</span><span class="hl-1">(ctx context.Context, percentage </span><span class="hl-5">int</span><span class="hl-1">) </span><span class="hl-5">error</span><span class="hl-1"> {</span><br/><span class="hl-1">                        log.</span><span class="hl-0">Printf</span><span class="hl-1">(</span><span class="hl-2">`Brewing Cafè Latte ... </span><span class="hl-8">%v%%</span><span class="hl-2"> done`</span><span class="hl-1">, percentage) </span><span class="hl-4">// This is new</span><br/><br/><span class="hl-1">                        </span><span class="hl-6">return</span><span class="hl-1"> </span><span class="hl-3">nil</span><br/><span class="hl-1">                    },</span><br/><span class="hl-1">                )</span><br/><br/><span class="hl-1">                </span><span class="hl-4">// ...</span><br/><br/><span class="hl-1">            </span><span class="hl-6">case</span><span class="hl-1"> </span><span class="hl-2">&quot;3</span><span class="hl-9">\n</span><span class="hl-2">&quot;</span><span class="hl-1">:</span><br/><span class="hl-1">                </span><span class="hl-6">fallthrough</span><br/><span class="hl-1">            </span><span class="hl-6">case</span><span class="hl-1"> </span><span class="hl-2">&quot;4</span><span class="hl-9">\n</span><span class="hl-2">&quot;</span><span class="hl-1">:</span><br/><span class="hl-1">                </span><span class="hl-8">res</span><span class="hl-1">, </span><span class="hl-8">err</span><span class="hl-1"> := remote.</span><span class="hl-0">BrewCoffee</span><span class="hl-1">(</span><br/><span class="hl-1">                    ctx,</span><br/><span class="hl-1">                    </span><span class="hl-2">&quot;americano&quot;</span><span class="hl-1">,</span><br/><span class="hl-1">                    </span><span class="hl-3">func</span><span class="hl-1">() </span><span class="hl-5">int</span><span class="hl-1"> {</span><br/><span class="hl-1">                        </span><span class="hl-6">if</span><span class="hl-1"> line == </span><span class="hl-2">&quot;1&quot;</span><span class="hl-1"> {</span><br/><span class="hl-1">                            </span><span class="hl-6">return</span><span class="hl-1"> </span><span class="hl-7">100</span><br/><span class="hl-1">                        } </span><span class="hl-6">else</span><span class="hl-1"> {</span><br/><span class="hl-1">                            </span><span class="hl-6">return</span><span class="hl-1"> </span><span class="hl-7">200</span><br/><span class="hl-1">                        }</span><br/><span class="hl-1">                    }(),</span><br/><span class="hl-1">                    </span><span class="hl-3">func</span><span class="hl-1">(ctx context.Context, percentage </span><span class="hl-5">int</span><span class="hl-1">) </span><span class="hl-5">error</span><span class="hl-1"> {</span><br/><span class="hl-1">                        log.</span><span class="hl-0">Printf</span><span class="hl-1">(</span><span class="hl-2">`Brewing Americano ... </span><span class="hl-8">%v%%</span><span class="hl-2"> done`</span><span class="hl-1">, percentage) </span><span class="hl-4">// This is new</span><br/><br/><span class="hl-1">                        </span><span class="hl-6">return</span><span class="hl-1"> </span><span class="hl-3">nil</span><br/><span class="hl-1">                    },</span><br/><span class="hl-1">                )</span><br/><br/><span class="hl-1">                </span><span class="hl-4">// ...</span><br/><br/><span class="hl-1">            </span><span class="hl-6">return</span><span class="hl-1"> </span><span class="hl-3">nil</span><br/><span class="hl-1">        }); err != </span><span class="hl-3">nil</span><span class="hl-1"> {</span><br/><span class="hl-1">            </span><span class="hl-0">panic</span><span class="hl-1">(err)</span><br/><span class="hl-1">        }</span><br/><span class="hl-1">    }</span><br/><span class="hl-1">}()</span>
</code></pre>
<p>Now that we can restart the coffee machine/server again like so:</p>
<pre><code class="language-shell"><span class="hl-0">$</span><span class="hl-1"> </span><span class="hl-2">go</span><span class="hl-1"> </span><span class="hl-2">run</span><span class="hl-1"> </span><span class="hl-2">./cmd/coffee-machine/main.go</span>
</code></pre>
<p>And connect the remote control/client to it again like so:</p>
<pre><code class="language-shell"><span class="hl-0">$</span><span class="hl-1"> </span><span class="hl-2">go</span><span class="hl-1"> </span><span class="hl-2">run</span><span class="hl-1"> </span><span class="hl-2">./cmd/remote-control/main.go</span>
</code></pre>
<p>You can now request the coffee machine to brew a coffee by pressing a number and <kbd>ENTER</kbd>. Once the RPC has been called, the coffee machine should print something like the following again:</p>
<pre><code class="language-plaintext">Brewing coffee variant latte in size 100 ml
</code></pre>
<p>And the remote control will print the progress as reported by the coffee machine to the terminal, before once again returning the remaining water level like so:</p>
<pre><code class="language-plaintext">Brewing Cafè Latte ... 0% done
Brewing Cafè Latte ... 25% done
Brewing Cafè Latte ... 50% done
Brewing Cafè Latte ... 75% done
Brewing Cafè Latte ... 100% done
Remaining water: 900 ml
</code></pre>
<p><strong>🚀 That&#39;s it!</strong> You&#39;ve successfully built a virtual coffee machine with support for brewing coffee, notifications when coffee is being brewed, and incremental coffee brewing progress reports. We can&#39;t wait to see what you&#39;re going to build next with panrpc! Be sure to take a look at the <a href="#reference">reference</a> and <a href="#examples">examples</a> for more information, or check out the complete sources for the <a href="./go/cmd/panrpc-example-websocket-coffee-server-cli/main.go">coffee machine server</a> and <a href="./go/cmd/panrpc-example-websocket-coffee-client-cli/main.go">coffee machine client/remote control</a> for a recap.</p>
</details>


<a href="#-typescript" id="-typescript" style="color: inherit; text-decoration: none;">
  <h3><img alt="typescript" src="https://cdn.simpleicons.org/typescript" style="vertical-align: middle;" height="20" width="20" /> TypeScript</h3>
</a>
<blockquote>
<p>Just looking for sample code? Check out the sources for the example <a href="./ts/bin/panrpc-example-websocket-coffee-server-cli.ts">coffee machine server</a> and <a href="./ts/bin/panrpc-example-websocket-coffee-client-cli.ts">coffee machine client/remote control</a>.</p>
</blockquote>

<a href="#1-choosing-a-transport-and-serializer-1" id="1-choosing-a-transport-and-serializer-1" style="color: inherit; text-decoration: none;">
  <h4>1. Choosing a Transport and Serializer</h4>
</a>
<details>
  <summary>Expand section</summary>

<p>Start by creating a new npm module for the tutorial and installing <code>@pojntfx/panrpc</code>:</p>
<pre><code class="language-shell"><span class="hl-0">$</span><span class="hl-1"> </span><span class="hl-2">mkdir</span><span class="hl-1"> </span><span class="hl-3">-p</span><span class="hl-1"> </span><span class="hl-2">panrpc-tutorial-typescript</span><br/><span class="hl-0">$</span><span class="hl-1"> </span><span class="hl-2">cd</span><span class="hl-1"> </span><span class="hl-2">panrpc-tutorial-typescript</span><br/><span class="hl-0">$</span><span class="hl-1"> </span><span class="hl-2">npm</span><span class="hl-1"> </span><span class="hl-2">init</span><span class="hl-1"> </span><span class="hl-3">-y</span><br/><span class="hl-0">$</span><span class="hl-1"> </span><span class="hl-2">npm</span><span class="hl-1"> </span><span class="hl-2">install</span><span class="hl-1"> </span><span class="hl-2">@pojntfx/panrpc</span>
</code></pre>
<p>The TypeScript version of panrpc supports many transports. While common ones are TCP, WebSockets, UNIX sockets or WebRTC, anything that directly implements or can be adapted to a <a href="https://developer.mozilla.org/en-US/docs/Web/API/Streams_API">WHATWG stream</a> can be used with the panrpc <a href="https://pojntfx.github.io/panrpc/classes/Registry.html#linkStream"><code>linkStream</code> API</a>. If you want to use a message broker like Redis or NATS as the transport, or need more control over the wire protocol, you can use the <a href="https://pojntfx.github.io/panrpc/classes/Registry.html#linkMessage"><code>linkMessage</code> API</a> instead. For this tutorial, we&#39;ll be using WebSockets as the transport through the <code>ws</code> library, which you can install like so:</p>
<pre><code class="language-shell"><span class="hl-0">$</span><span class="hl-1"> </span><span class="hl-2">npm</span><span class="hl-1"> </span><span class="hl-2">install</span><span class="hl-1"> </span><span class="hl-2">ws</span>
</code></pre>
<p>In addition to supporting many transports, the TypeScript version of panrpc also supports different serializers. Common ones are JSON and CBOR, but similarly to transports anything that implements or can be adapted to a WHATWG stream can be used. For this tutorial, we&#39;ll be using JSON as the serializer through the <code>@streamparser/json-whatwg</code> library, which you can install like so:</p>
<pre><code class="language-shell"><span class="hl-0">$</span><span class="hl-1"> </span><span class="hl-2">npm</span><span class="hl-1"> </span><span class="hl-2">install</span><span class="hl-1"> </span><span class="hl-2">@streamparser/json-whatwg</span>
</code></pre>
</details>


<a href="#2-creating-a-server-1" id="2-creating-a-server-1" style="color: inherit; text-decoration: none;">
  <h4>2. Creating a Server</h4>
</a>
<p>In this tutorial we&#39;ll be creating a simple coffee machine server that simulates brewing coffee, and can be controlled by using a remote control (the coffee machine client).</p>
<details>
  <summary>Expand section</summary>

<p>To start with implementing the coffee machine server, create a new file <code>coffee-machine.ts</code> and define a basic class with a <code>BrewCoffee</code> method. This method simulates brewing coffee by validating the coffee variant, checking if there is enough water available to brew the coffee, sleeping for five seconds, and returning the new water level to the remote control:</p>
<pre><code class="language-typescript"><span class="hl-4">// coffee-machine.ts</span><br/><br/><span class="hl-6">import</span><span class="hl-1"> { </span><span class="hl-8">ILocalContext</span><span class="hl-1"> } </span><span class="hl-6">from</span><span class="hl-1"> </span><span class="hl-2">&quot;@pojntfx/panrpc&quot;</span><span class="hl-1">;</span><br/><br/><span class="hl-3">class</span><span class="hl-1"> </span><span class="hl-5">CoffeeMachine</span><span class="hl-1"> {</span><br/><span class="hl-1">  </span><span class="hl-3">constructor</span><span class="hl-1">(</span><span class="hl-3">private</span><span class="hl-1"> </span><span class="hl-8">supportedVariants</span><span class="hl-1">: </span><span class="hl-5">string</span><span class="hl-1">[], </span><span class="hl-3">private</span><span class="hl-1"> </span><span class="hl-8">waterLevel</span><span class="hl-1">: </span><span class="hl-5">number</span><span class="hl-1">) {</span><br/><span class="hl-1">    </span><span class="hl-3">this</span><span class="hl-1">.</span><span class="hl-8">BrewCoffee</span><span class="hl-1"> = </span><span class="hl-3">this</span><span class="hl-1">.</span><span class="hl-8">BrewCoffee</span><span class="hl-1">.</span><span class="hl-0">bind</span><span class="hl-1">(</span><span class="hl-3">this</span><span class="hl-1">);</span><br/><span class="hl-1">  }</span><br/><br/><span class="hl-1">  </span><span class="hl-3">async</span><span class="hl-1"> </span><span class="hl-0">BrewCoffee</span><span class="hl-1">(</span><br/><span class="hl-1">    </span><span class="hl-8">ctx</span><span class="hl-1">: </span><span class="hl-5">ILocalContext</span><span class="hl-1">,</span><br/><span class="hl-1">    </span><span class="hl-8">variant</span><span class="hl-1">: </span><span class="hl-5">string</span><span class="hl-1">,</span><br/><span class="hl-1">    </span><span class="hl-8">size</span><span class="hl-1">: </span><span class="hl-5">number</span><br/><span class="hl-1">  ): </span><span class="hl-5">Promise</span><span class="hl-1">&lt;</span><span class="hl-5">number</span><span class="hl-1">&gt; {</span><br/><span class="hl-1">    </span><span class="hl-6">if</span><span class="hl-1"> (!</span><span class="hl-3">this</span><span class="hl-1">.</span><span class="hl-8">supportedVariants</span><span class="hl-1">.</span><span class="hl-0">includes</span><span class="hl-1">(</span><span class="hl-8">variant</span><span class="hl-1">)) {</span><br/><span class="hl-1">      </span><span class="hl-6">throw</span><span class="hl-1"> </span><span class="hl-3">new</span><span class="hl-1"> </span><span class="hl-0">Error</span><span class="hl-1">(</span><span class="hl-2">&quot;unsupported variant&quot;</span><span class="hl-1">);</span><br/><span class="hl-1">    }</span><br/><br/><span class="hl-1">    </span><span class="hl-6">if</span><span class="hl-1"> (</span><span class="hl-3">this</span><span class="hl-1">.</span><span class="hl-8">waterLevel</span><span class="hl-1"> - </span><span class="hl-8">size</span><span class="hl-1"> &lt; </span><span class="hl-7">0</span><span class="hl-1">) {</span><br/><span class="hl-1">      </span><span class="hl-6">throw</span><span class="hl-1"> </span><span class="hl-3">new</span><span class="hl-1"> </span><span class="hl-0">Error</span><span class="hl-1">(</span><span class="hl-2">&quot;not enough water&quot;</span><span class="hl-1">);</span><br/><span class="hl-1">    }</span><br/><br/><span class="hl-1">    </span><span class="hl-8">console</span><span class="hl-1">.</span><span class="hl-0">log</span><span class="hl-1">(</span><span class="hl-2">&quot;Brewing coffee variant&quot;</span><span class="hl-1">, </span><span class="hl-8">variant</span><span class="hl-1">, </span><span class="hl-2">&quot;in size&quot;</span><span class="hl-1">, </span><span class="hl-8">size</span><span class="hl-1">, </span><span class="hl-2">&quot;ml&quot;</span><span class="hl-1">);</span><br/><br/><span class="hl-1">    </span><span class="hl-6">await</span><span class="hl-1"> </span><span class="hl-3">new</span><span class="hl-1"> </span><span class="hl-5">Promise</span><span class="hl-1">((</span><span class="hl-8">r</span><span class="hl-1">) </span><span class="hl-3">=&gt;</span><span class="hl-1"> {</span><br/><span class="hl-1">      </span><span class="hl-0">setTimeout</span><span class="hl-1">(</span><span class="hl-8">r</span><span class="hl-1">, </span><span class="hl-7">5000</span><span class="hl-1">);</span><br/><span class="hl-1">    });</span><br/><br/><span class="hl-1">    </span><span class="hl-3">this</span><span class="hl-1">.</span><span class="hl-8">waterLevel</span><span class="hl-1"> -= </span><span class="hl-8">size</span><span class="hl-1">;</span><br/><br/><span class="hl-1">    </span><span class="hl-6">return</span><span class="hl-1"> </span><span class="hl-3">this</span><span class="hl-1">.</span><span class="hl-8">waterLevel</span><span class="hl-1">;</span><br/><span class="hl-1">  }</span><br/><span class="hl-1">}</span>
</code></pre>
<blockquote>
<p>The following limitations on which methods can be exposed as RPCs exist:</p>
<ul>
<li>Methods must have <code>ILocalContext</code> as their first argument</li>
<li>Methods can not have variadic arguments</li>
</ul>
</blockquote>
<p>To start turning the <code>BrewCoffee</code> method into an RPC, create an instance of the class and pass it to a <a href="https://pojntfx.github.io/panrpc/classes/Registry.html">panrpc Registry</a> like so:</p>
<pre><code class="language-typescript"><span class="hl-4">// coffee-machine.ts</span><br/><br/><span class="hl-6">import</span><span class="hl-1"> { </span><span class="hl-8">Registry</span><span class="hl-1"> } </span><span class="hl-6">from</span><span class="hl-1"> </span><span class="hl-2">&quot;@pojntfx/panrpc&quot;</span><span class="hl-1">;</span><br/><br/><span class="hl-3">const</span><span class="hl-1"> </span><span class="hl-11">service</span><span class="hl-1"> = </span><span class="hl-3">new</span><span class="hl-1"> </span><span class="hl-0">CoffeeMachine</span><span class="hl-1">([</span><span class="hl-2">&quot;latte&quot;</span><span class="hl-1">, </span><span class="hl-2">&quot;americano&quot;</span><span class="hl-1">], </span><span class="hl-7">1000</span><span class="hl-1">);</span><br/><br/><span class="hl-3">let</span><span class="hl-1"> </span><span class="hl-8">clients</span><span class="hl-1"> = </span><span class="hl-7">0</span><span class="hl-1">;</span><br/><br/><span class="hl-3">const</span><span class="hl-1"> </span><span class="hl-11">registry</span><span class="hl-1"> = </span><span class="hl-3">new</span><span class="hl-1"> </span><span class="hl-0">Registry</span><span class="hl-1">(</span><br/><span class="hl-1">  </span><span class="hl-8">service</span><span class="hl-1">,</span><br/><span class="hl-1">  </span><span class="hl-3">new</span><span class="hl-1"> (</span><span class="hl-3">class</span><span class="hl-1"> {})(),</span><br/><br/><span class="hl-1">  {</span><br/><span class="hl-1">    </span><span class="hl-0">onClientConnect</span><span class="hl-8">:</span><span class="hl-1"> () </span><span class="hl-3">=&gt;</span><span class="hl-1"> {</span><br/><span class="hl-1">      </span><span class="hl-8">clients</span><span class="hl-1">++;</span><br/><br/><span class="hl-1">      </span><span class="hl-8">console</span><span class="hl-1">.</span><span class="hl-0">log</span><span class="hl-1">(</span><span class="hl-8">clients</span><span class="hl-1">, </span><span class="hl-2">&quot;remote controls connected&quot;</span><span class="hl-1">);</span><br/><span class="hl-1">    },</span><br/><span class="hl-1">    </span><span class="hl-0">onClientDisconnect</span><span class="hl-8">:</span><span class="hl-1"> () </span><span class="hl-3">=&gt;</span><span class="hl-1"> {</span><br/><span class="hl-1">      </span><span class="hl-8">clients</span><span class="hl-1">--;</span><br/><br/><span class="hl-1">      </span><span class="hl-8">console</span><span class="hl-1">.</span><span class="hl-0">log</span><span class="hl-1">(</span><span class="hl-8">clients</span><span class="hl-1">, </span><span class="hl-2">&quot;remote controls connected&quot;</span><span class="hl-1">);</span><br/><span class="hl-1">    },</span><br/><span class="hl-1">  }</span><br/><span class="hl-1">);</span>
</code></pre>
<p>Now that we have a registry that provides our coffee machine&#39;s RPCs, we can link it to our transport (WebSockets) and serializer of choice (JSON). This requires a bit of boilerplate since the <code>ws</code> library doesn&#39;t provide WHATWG streams directly yet, so feel free to copy-and-paste this:</p>
<details>
  <summary>Expand boilerplate code snippet</summary>

<pre><code class="language-typescript"><span class="hl-4">// coffee-machine.ts</span><br/><br/><span class="hl-6">import</span><span class="hl-1"> { </span><span class="hl-8">JSONParser</span><span class="hl-1"> } </span><span class="hl-6">from</span><span class="hl-1"> </span><span class="hl-2">&quot;@streamparser/json-whatwg&quot;</span><span class="hl-1">;</span><br/><span class="hl-6">import</span><span class="hl-1"> { </span><span class="hl-8">WebSocketServer</span><span class="hl-1"> } </span><span class="hl-6">from</span><span class="hl-1"> </span><span class="hl-2">&quot;ws&quot;</span><span class="hl-1">;</span><br/><br/><span class="hl-3">const</span><span class="hl-1"> </span><span class="hl-11">server</span><span class="hl-1"> = </span><span class="hl-3">new</span><span class="hl-1"> </span><span class="hl-0">WebSocketServer</span><span class="hl-1">({</span><br/><span class="hl-1">  </span><span class="hl-8">host:</span><span class="hl-1"> </span><span class="hl-2">&quot;127.0.0.1&quot;</span><span class="hl-1">,</span><br/><span class="hl-1">  </span><span class="hl-8">port:</span><span class="hl-1"> </span><span class="hl-7">1337</span><span class="hl-1">,</span><br/><span class="hl-1">});</span><br/><br/><span class="hl-8">server</span><span class="hl-1">.</span><span class="hl-0">on</span><span class="hl-1">(</span><span class="hl-2">&quot;connection&quot;</span><span class="hl-1">, (</span><span class="hl-8">socket</span><span class="hl-1">) </span><span class="hl-3">=&gt;</span><span class="hl-1"> {</span><br/><span class="hl-1">  </span><span class="hl-8">socket</span><span class="hl-1">.</span><span class="hl-0">addEventListener</span><span class="hl-1">(</span><span class="hl-2">&quot;error&quot;</span><span class="hl-1">, (</span><span class="hl-8">e</span><span class="hl-1">) </span><span class="hl-3">=&gt;</span><span class="hl-1"> {</span><br/><span class="hl-1">    </span><span class="hl-8">console</span><span class="hl-1">.</span><span class="hl-0">error</span><span class="hl-1">(</span><span class="hl-2">&quot;Remote control disconnected with error:&quot;</span><span class="hl-1">, </span><span class="hl-8">e</span><span class="hl-1">);</span><br/><span class="hl-1">  });</span><br/><br/><span class="hl-1">  </span><span class="hl-3">const</span><span class="hl-1"> </span><span class="hl-11">encoder</span><span class="hl-1"> = </span><span class="hl-3">new</span><span class="hl-1"> </span><span class="hl-0">WritableStream</span><span class="hl-1">({</span><br/><span class="hl-1">    </span><span class="hl-0">write</span><span class="hl-1">(</span><span class="hl-8">chunk</span><span class="hl-1">) {</span><br/><span class="hl-1">      </span><span class="hl-8">socket</span><span class="hl-1">.</span><span class="hl-0">send</span><span class="hl-1">(</span><span class="hl-11">JSON</span><span class="hl-1">.</span><span class="hl-0">stringify</span><span class="hl-1">(</span><span class="hl-8">chunk</span><span class="hl-1">));</span><br/><span class="hl-1">    },</span><br/><span class="hl-1">  });</span><br/><br/><span class="hl-1">  </span><span class="hl-3">const</span><span class="hl-1"> </span><span class="hl-11">parser</span><span class="hl-1"> = </span><span class="hl-3">new</span><span class="hl-1"> </span><span class="hl-0">JSONParser</span><span class="hl-1">({</span><br/><span class="hl-1">    </span><span class="hl-8">paths:</span><span class="hl-1"> [</span><span class="hl-2">&quot;$&quot;</span><span class="hl-1">],</span><br/><span class="hl-1">    </span><span class="hl-8">separator:</span><span class="hl-1"> </span><span class="hl-2">&quot;&quot;</span><span class="hl-1">,</span><br/><span class="hl-1">  });</span><br/><span class="hl-1">  </span><span class="hl-3">const</span><span class="hl-1"> </span><span class="hl-11">parserWriter</span><span class="hl-1"> = </span><span class="hl-8">parser</span><span class="hl-1">.</span><span class="hl-8">writable</span><span class="hl-1">.</span><span class="hl-0">getWriter</span><span class="hl-1">();</span><br/><span class="hl-1">  </span><span class="hl-3">const</span><span class="hl-1"> </span><span class="hl-11">parserReader</span><span class="hl-1"> = </span><span class="hl-8">parser</span><span class="hl-1">.</span><span class="hl-8">readable</span><span class="hl-1">.</span><span class="hl-0">getReader</span><span class="hl-1">();</span><br/><span class="hl-1">  </span><span class="hl-3">const</span><span class="hl-1"> </span><span class="hl-11">decoder</span><span class="hl-1"> = </span><span class="hl-3">new</span><span class="hl-1"> </span><span class="hl-0">ReadableStream</span><span class="hl-1">({</span><br/><span class="hl-1">    </span><span class="hl-0">start</span><span class="hl-1">(</span><span class="hl-8">controller</span><span class="hl-1">) {</span><br/><span class="hl-1">      </span><span class="hl-8">parserReader</span><br/><span class="hl-1">        .</span><span class="hl-0">read</span><span class="hl-1">()</span><br/><span class="hl-1">        .</span><span class="hl-0">then</span><span class="hl-1">(</span><span class="hl-3">async</span><span class="hl-1"> </span><span class="hl-3">function</span><span class="hl-1"> </span><span class="hl-0">process</span><span class="hl-1">({ </span><span class="hl-8">done</span><span class="hl-1">, </span><span class="hl-8">value</span><span class="hl-1"> }) {</span><br/><span class="hl-1">          </span><span class="hl-6">if</span><span class="hl-1"> (</span><span class="hl-8">done</span><span class="hl-1">) {</span><br/><span class="hl-1">            </span><span class="hl-8">controller</span><span class="hl-1">.</span><span class="hl-0">close</span><span class="hl-1">();</span><br/><br/><span class="hl-1">            </span><span class="hl-6">return</span><span class="hl-1">;</span><br/><span class="hl-1">          }</span><br/><br/><span class="hl-1">          </span><span class="hl-8">controller</span><span class="hl-1">.</span><span class="hl-0">enqueue</span><span class="hl-1">(</span><span class="hl-8">value</span><span class="hl-1">?.</span><span class="hl-8">value</span><span class="hl-1">);</span><br/><br/><span class="hl-1">          </span><span class="hl-8">parserReader</span><br/><span class="hl-1">            .</span><span class="hl-0">read</span><span class="hl-1">()</span><br/><span class="hl-1">            .</span><span class="hl-0">then</span><span class="hl-1">(</span><span class="hl-8">process</span><span class="hl-1">)</span><br/><span class="hl-1">            .</span><span class="hl-0">catch</span><span class="hl-1">((</span><span class="hl-8">e</span><span class="hl-1">) </span><span class="hl-3">=&gt;</span><span class="hl-1"> </span><span class="hl-8">controller</span><span class="hl-1">.</span><span class="hl-0">error</span><span class="hl-1">(</span><span class="hl-8">e</span><span class="hl-1">));</span><br/><span class="hl-1">        })</span><br/><span class="hl-1">        .</span><span class="hl-0">catch</span><span class="hl-1">((</span><span class="hl-8">e</span><span class="hl-1">) </span><span class="hl-3">=&gt;</span><span class="hl-1"> </span><span class="hl-8">controller</span><span class="hl-1">.</span><span class="hl-0">error</span><span class="hl-1">(</span><span class="hl-8">e</span><span class="hl-1">));</span><br/><span class="hl-1">    },</span><br/><span class="hl-1">  });</span><br/><span class="hl-1">  </span><span class="hl-8">socket</span><span class="hl-1">.</span><span class="hl-0">addEventListener</span><span class="hl-1">(</span><span class="hl-2">&quot;message&quot;</span><span class="hl-1">, (</span><span class="hl-8">m</span><span class="hl-1">) </span><span class="hl-3">=&gt;</span><br/><span class="hl-1">    </span><span class="hl-8">parserWriter</span><span class="hl-1">.</span><span class="hl-0">write</span><span class="hl-1">(</span><span class="hl-8">m</span><span class="hl-1">.</span><span class="hl-8">data</span><span class="hl-1"> </span><span class="hl-6">as</span><span class="hl-1"> </span><span class="hl-5">string</span><span class="hl-1">)</span><br/><span class="hl-1">  );</span><br/><span class="hl-1">  </span><span class="hl-8">socket</span><span class="hl-1">.</span><span class="hl-0">addEventListener</span><span class="hl-1">(</span><span class="hl-2">&quot;close&quot;</span><span class="hl-1">, () </span><span class="hl-3">=&gt;</span><span class="hl-1"> {</span><br/><span class="hl-1">    </span><span class="hl-8">parserReader</span><span class="hl-1">.</span><span class="hl-0">cancel</span><span class="hl-1">();</span><br/><span class="hl-1">    </span><span class="hl-8">parserWriter</span><span class="hl-1">.</span><span class="hl-0">abort</span><span class="hl-1">();</span><br/><span class="hl-1">  });</span><br/><br/><span class="hl-1">  </span><span class="hl-8">registry</span><span class="hl-1">.</span><span class="hl-0">linkStream</span><span class="hl-1">(</span><br/><span class="hl-1">    </span><span class="hl-8">encoder</span><span class="hl-1">,</span><br/><span class="hl-1">    </span><span class="hl-8">decoder</span><span class="hl-1">,</span><br/><br/><span class="hl-1">    (</span><span class="hl-8">v</span><span class="hl-1">) </span><span class="hl-3">=&gt;</span><span class="hl-1"> </span><span class="hl-8">v</span><span class="hl-1">,</span><br/><span class="hl-1">    (</span><span class="hl-8">v</span><span class="hl-1">) </span><span class="hl-3">=&gt;</span><span class="hl-1"> </span><span class="hl-8">v</span><br/><span class="hl-1">  );</span><br/><span class="hl-1">});</span><br/><br/><span class="hl-8">console</span><span class="hl-1">.</span><span class="hl-0">log</span><span class="hl-1">(</span><span class="hl-2">&quot;Listening on localhost:1337&quot;</span><span class="hl-1">);</span>
</code></pre>
</details>

<p><strong>Congratulations!</strong> You&#39;ve created your first panrpc server. You can start it from your terminal like so:</p>
<pre><code class="language-shell"><span class="hl-0">$</span><span class="hl-1"> </span><span class="hl-2">npx</span><span class="hl-1"> </span><span class="hl-2">tsx</span><span class="hl-1"> </span><span class="hl-2">coffee-machine.ts</span>
</code></pre>
<p>You should now see the following in your terminal, which means that the server is available on <code>localhost:1337</code>:</p>
<pre><code class="language-plaintext">Listening on localhost:1337
</code></pre>
</details>


<a href="#3-creating-a-client-1" id="3-creating-a-client-1" style="color: inherit; text-decoration: none;">
  <h4>3. Creating a Client</h4>
</a>
<p>In order to interact with the coffee machine server, we&#39;ll now create the remote control (the coffee machine client), which will call the <code>BrewCoffee</code> RPC.</p>
<details>
  <summary>Expand section</summary>

<p>To start with implementing the remote control, create a new file <code>remote-control.ts</code> and define a basic class with a placeholder method that mirrors the <code>BrewCoffee</code> RPC:</p>
<pre><code class="language-typescript"><span class="hl-4">// remote-control.ts</span><br/><br/><span class="hl-6">import</span><span class="hl-1"> { </span><span class="hl-8">IRemoteContext</span><span class="hl-1"> } </span><span class="hl-6">from</span><span class="hl-1"> </span><span class="hl-2">&quot;@pojntfx/panrpc&quot;</span><span class="hl-1">;</span><br/><br/><span class="hl-3">class</span><span class="hl-1"> </span><span class="hl-5">CoffeeMachine</span><span class="hl-1"> {</span><br/><span class="hl-1">  </span><span class="hl-3">async</span><span class="hl-1"> </span><span class="hl-0">BrewCoffee</span><span class="hl-1">(</span><br/><span class="hl-1">    </span><span class="hl-8">ctx</span><span class="hl-1">: </span><span class="hl-5">IRemoteContext</span><span class="hl-1">,</span><br/><span class="hl-1">    </span><span class="hl-8">variant</span><span class="hl-1">: </span><span class="hl-5">string</span><span class="hl-1">,</span><br/><span class="hl-1">    </span><span class="hl-8">size</span><span class="hl-1">: </span><span class="hl-5">number</span><br/><span class="hl-1">  ): </span><span class="hl-5">Promise</span><span class="hl-1">&lt;</span><span class="hl-5">number</span><span class="hl-1">&gt; {</span><br/><span class="hl-1">    </span><span class="hl-6">return</span><span class="hl-1"> </span><span class="hl-7">0</span><span class="hl-1">;</span><br/><span class="hl-1">  }</span><br/><span class="hl-1">}</span>
</code></pre>
<blockquote>
<p>Placeholder methods must have <code>IRemoteContext</code> instead of <code>ILocalContext</code> as their first argument.</p>
</blockquote>
<p>In order to make the <code>BrewCoffee</code> placeholder method do RPC calls, create an instance of the class and pass it to a <a href="https://pojntfx.github.io/panrpc/classes/Registry.html">panrpc Registry</a> like so:</p>
<pre><code class="language-typescript"><span class="hl-4">// remote-control.ts</span><br/><br/><span class="hl-6">import</span><span class="hl-1"> { </span><span class="hl-8">Registry</span><span class="hl-1"> } </span><span class="hl-6">from</span><span class="hl-1"> </span><span class="hl-2">&quot;@pojntfx/panrpc&quot;</span><span class="hl-1">;</span><br/><br/><span class="hl-3">let</span><span class="hl-1"> </span><span class="hl-8">clients</span><span class="hl-1"> = </span><span class="hl-7">0</span><span class="hl-1">;</span><br/><br/><span class="hl-3">const</span><span class="hl-1"> </span><span class="hl-11">registry</span><span class="hl-1"> = </span><span class="hl-3">new</span><span class="hl-1"> </span><span class="hl-0">Registry</span><span class="hl-1">(</span><br/><span class="hl-1">  </span><span class="hl-3">new</span><span class="hl-1"> (</span><span class="hl-3">class</span><span class="hl-1"> {})(),</span><br/><span class="hl-1">  </span><span class="hl-3">new</span><span class="hl-1"> </span><span class="hl-0">CoffeeMachine</span><span class="hl-1">(),</span><br/><br/><span class="hl-1">  {</span><br/><span class="hl-1">    </span><span class="hl-0">onClientConnect</span><span class="hl-8">:</span><span class="hl-1"> () </span><span class="hl-3">=&gt;</span><span class="hl-1"> {</span><br/><span class="hl-1">      </span><span class="hl-8">clients</span><span class="hl-1">++;</span><br/><br/><span class="hl-1">      </span><span class="hl-8">console</span><span class="hl-1">.</span><span class="hl-0">log</span><span class="hl-1">(</span><span class="hl-8">clients</span><span class="hl-1">, </span><span class="hl-2">&quot;coffee machines connected&quot;</span><span class="hl-1">);</span><br/><span class="hl-1">    },</span><br/><span class="hl-1">    </span><span class="hl-0">onClientDisconnect</span><span class="hl-8">:</span><span class="hl-1"> () </span><span class="hl-3">=&gt;</span><span class="hl-1"> {</span><br/><span class="hl-1">      </span><span class="hl-8">clients</span><span class="hl-1">--;</span><br/><br/><span class="hl-1">      </span><span class="hl-8">console</span><span class="hl-1">.</span><span class="hl-0">log</span><span class="hl-1">(</span><span class="hl-8">clients</span><span class="hl-1">, </span><span class="hl-2">&quot;coffee machines connected&quot;</span><span class="hl-1">);</span><br/><span class="hl-1">    },</span><br/><span class="hl-1">  }</span><br/><span class="hl-1">);</span>
</code></pre>
<p>Now that we have a registry that turns the remote control&#39;s placeholder methods into RPC calls, we can link it to our transport (WebSockets) and serializer of choice (JSON). Once again, this requires a bit of boilerplate since the <code>ws</code> library doesn&#39;t provide WHATWG streams directly yet, so feel free to copy-and-paste this:</p>
<details>
  <summary>Expand boilerplate code snippet</summary>

<pre><code class="language-typescript"><span class="hl-4">// remote-control.ts</span><br/><br/><span class="hl-6">import</span><span class="hl-1"> { </span><span class="hl-8">JSONParser</span><span class="hl-1"> } </span><span class="hl-6">from</span><span class="hl-1"> </span><span class="hl-2">&quot;@streamparser/json-whatwg&quot;</span><span class="hl-1">;</span><br/><span class="hl-6">import</span><span class="hl-1"> { </span><span class="hl-8">WebSocket</span><span class="hl-1"> } </span><span class="hl-6">from</span><span class="hl-1"> </span><span class="hl-2">&quot;ws&quot;</span><span class="hl-1">;</span><br/><br/><span class="hl-3">const</span><span class="hl-1"> </span><span class="hl-11">socket</span><span class="hl-1"> = </span><span class="hl-3">new</span><span class="hl-1"> </span><span class="hl-0">WebSocket</span><span class="hl-1">(</span><span class="hl-2">&quot;ws://127.0.0.1:1337&quot;</span><span class="hl-1">);</span><br/><br/><span class="hl-8">socket</span><span class="hl-1">.</span><span class="hl-0">addEventListener</span><span class="hl-1">(</span><span class="hl-2">&quot;error&quot;</span><span class="hl-1">, (</span><span class="hl-8">e</span><span class="hl-1">) </span><span class="hl-3">=&gt;</span><span class="hl-1"> {</span><br/><span class="hl-1">  </span><span class="hl-8">console</span><span class="hl-1">.</span><span class="hl-0">error</span><span class="hl-1">(</span><span class="hl-2">&quot;Disconnected with error:&quot;</span><span class="hl-1">, </span><span class="hl-8">e</span><span class="hl-1">);</span><br/><br/><span class="hl-1">  </span><span class="hl-0">exit</span><span class="hl-1">(</span><span class="hl-7">1</span><span class="hl-1">);</span><br/><span class="hl-1">});</span><br/><span class="hl-8">socket</span><span class="hl-1">.</span><span class="hl-0">addEventListener</span><span class="hl-1">(</span><span class="hl-2">&quot;close&quot;</span><span class="hl-1">, () </span><span class="hl-3">=&gt;</span><span class="hl-1"> </span><span class="hl-0">exit</span><span class="hl-1">(</span><span class="hl-7">0</span><span class="hl-1">));</span><br/><br/><span class="hl-6">await</span><span class="hl-1"> </span><span class="hl-3">new</span><span class="hl-1"> </span><span class="hl-5">Promise</span><span class="hl-1">&lt;</span><span class="hl-5">void</span><span class="hl-1">&gt;((</span><span class="hl-8">res</span><span class="hl-1">, </span><span class="hl-8">rej</span><span class="hl-1">) </span><span class="hl-3">=&gt;</span><span class="hl-1"> {</span><br/><span class="hl-1">  </span><span class="hl-8">socket</span><span class="hl-1">.</span><span class="hl-0">addEventListener</span><span class="hl-1">(</span><span class="hl-2">&quot;open&quot;</span><span class="hl-1">, () </span><span class="hl-3">=&gt;</span><span class="hl-1"> </span><span class="hl-0">res</span><span class="hl-1">());</span><br/><span class="hl-1">  </span><span class="hl-8">socket</span><span class="hl-1">.</span><span class="hl-0">addEventListener</span><span class="hl-1">(</span><span class="hl-2">&quot;error&quot;</span><span class="hl-1">, </span><span class="hl-8">rej</span><span class="hl-1">);</span><br/><span class="hl-1">});</span><br/><br/><span class="hl-3">const</span><span class="hl-1"> </span><span class="hl-11">encoder</span><span class="hl-1"> = </span><span class="hl-3">new</span><span class="hl-1"> </span><span class="hl-0">WritableStream</span><span class="hl-1">({</span><br/><span class="hl-1">  </span><span class="hl-0">write</span><span class="hl-1">(</span><span class="hl-8">chunk</span><span class="hl-1">) {</span><br/><span class="hl-1">    </span><span class="hl-8">socket</span><span class="hl-1">.</span><span class="hl-0">send</span><span class="hl-1">(</span><span class="hl-11">JSON</span><span class="hl-1">.</span><span class="hl-0">stringify</span><span class="hl-1">(</span><span class="hl-8">chunk</span><span class="hl-1">));</span><br/><span class="hl-1">  },</span><br/><span class="hl-1">});</span><br/><br/><span class="hl-3">const</span><span class="hl-1"> </span><span class="hl-11">parser</span><span class="hl-1"> = </span><span class="hl-3">new</span><span class="hl-1"> </span><span class="hl-0">JSONParser</span><span class="hl-1">({</span><br/><span class="hl-1">  </span><span class="hl-8">paths:</span><span class="hl-1"> [</span><span class="hl-2">&quot;$&quot;</span><span class="hl-1">],</span><br/><span class="hl-1">  </span><span class="hl-8">separator:</span><span class="hl-1"> </span><span class="hl-2">&quot;&quot;</span><span class="hl-1">,</span><br/><span class="hl-1">});</span><br/><span class="hl-3">const</span><span class="hl-1"> </span><span class="hl-11">parserWriter</span><span class="hl-1"> = </span><span class="hl-8">parser</span><span class="hl-1">.</span><span class="hl-8">writable</span><span class="hl-1">.</span><span class="hl-0">getWriter</span><span class="hl-1">();</span><br/><span class="hl-3">const</span><span class="hl-1"> </span><span class="hl-11">parserReader</span><span class="hl-1"> = </span><span class="hl-8">parser</span><span class="hl-1">.</span><span class="hl-8">readable</span><span class="hl-1">.</span><span class="hl-0">getReader</span><span class="hl-1">();</span><br/><span class="hl-3">const</span><span class="hl-1"> </span><span class="hl-11">decoder</span><span class="hl-1"> = </span><span class="hl-3">new</span><span class="hl-1"> </span><span class="hl-0">ReadableStream</span><span class="hl-1">({</span><br/><span class="hl-1">  </span><span class="hl-0">start</span><span class="hl-1">(</span><span class="hl-8">controller</span><span class="hl-1">) {</span><br/><span class="hl-1">    </span><span class="hl-8">parserReader</span><br/><span class="hl-1">      .</span><span class="hl-0">read</span><span class="hl-1">()</span><br/><span class="hl-1">      .</span><span class="hl-0">then</span><span class="hl-1">(</span><span class="hl-3">async</span><span class="hl-1"> </span><span class="hl-3">function</span><span class="hl-1"> </span><span class="hl-0">process</span><span class="hl-1">({ </span><span class="hl-8">done</span><span class="hl-1">, </span><span class="hl-8">value</span><span class="hl-1"> }) {</span><br/><span class="hl-1">        </span><span class="hl-6">if</span><span class="hl-1"> (</span><span class="hl-8">done</span><span class="hl-1">) {</span><br/><span class="hl-1">          </span><span class="hl-8">controller</span><span class="hl-1">.</span><span class="hl-0">close</span><span class="hl-1">();</span><br/><br/><span class="hl-1">          </span><span class="hl-6">return</span><span class="hl-1">;</span><br/><span class="hl-1">        }</span><br/><br/><span class="hl-1">        </span><span class="hl-8">controller</span><span class="hl-1">.</span><span class="hl-0">enqueue</span><span class="hl-1">(</span><span class="hl-8">value</span><span class="hl-1">?.</span><span class="hl-8">value</span><span class="hl-1">);</span><br/><br/><span class="hl-1">        </span><span class="hl-8">parserReader</span><br/><span class="hl-1">          .</span><span class="hl-0">read</span><span class="hl-1">()</span><br/><span class="hl-1">          .</span><span class="hl-0">then</span><span class="hl-1">(</span><span class="hl-8">process</span><span class="hl-1">)</span><br/><span class="hl-1">          .</span><span class="hl-0">catch</span><span class="hl-1">((</span><span class="hl-8">e</span><span class="hl-1">) </span><span class="hl-3">=&gt;</span><span class="hl-1"> </span><span class="hl-8">controller</span><span class="hl-1">.</span><span class="hl-0">error</span><span class="hl-1">(</span><span class="hl-8">e</span><span class="hl-1">));</span><br/><span class="hl-1">      })</span><br/><span class="hl-1">      .</span><span class="hl-0">catch</span><span class="hl-1">((</span><span class="hl-8">e</span><span class="hl-1">) </span><span class="hl-3">=&gt;</span><span class="hl-1"> </span><span class="hl-8">controller</span><span class="hl-1">.</span><span class="hl-0">error</span><span class="hl-1">(</span><span class="hl-8">e</span><span class="hl-1">));</span><br/><span class="hl-1">  },</span><br/><span class="hl-1">});</span><br/><span class="hl-8">socket</span><span class="hl-1">.</span><span class="hl-0">addEventListener</span><span class="hl-1">(</span><span class="hl-2">&quot;message&quot;</span><span class="hl-1">, (</span><span class="hl-8">m</span><span class="hl-1">) </span><span class="hl-3">=&gt;</span><span class="hl-1"> </span><span class="hl-8">parserWriter</span><span class="hl-1">.</span><span class="hl-0">write</span><span class="hl-1">(</span><span class="hl-8">m</span><span class="hl-1">.</span><span class="hl-8">data</span><span class="hl-1"> </span><span class="hl-6">as</span><span class="hl-1"> </span><span class="hl-5">string</span><span class="hl-1">));</span><br/><span class="hl-8">socket</span><span class="hl-1">.</span><span class="hl-0">addEventListener</span><span class="hl-1">(</span><span class="hl-2">&quot;close&quot;</span><span class="hl-1">, () </span><span class="hl-3">=&gt;</span><span class="hl-1"> {</span><br/><span class="hl-1">  </span><span class="hl-8">parserReader</span><span class="hl-1">.</span><span class="hl-0">cancel</span><span class="hl-1">();</span><br/><span class="hl-1">  </span><span class="hl-8">parserWriter</span><span class="hl-1">.</span><span class="hl-0">abort</span><span class="hl-1">();</span><br/><span class="hl-1">});</span><br/><br/><span class="hl-8">registry</span><span class="hl-1">.</span><span class="hl-0">linkStream</span><span class="hl-1">(</span><br/><span class="hl-1">  </span><span class="hl-8">encoder</span><span class="hl-1">,</span><br/><span class="hl-1">  </span><span class="hl-8">decoder</span><span class="hl-1">,</span><br/><br/><span class="hl-1">  (</span><span class="hl-8">v</span><span class="hl-1">) </span><span class="hl-3">=&gt;</span><span class="hl-1"> </span><span class="hl-8">v</span><span class="hl-1">,</span><br/><span class="hl-1">  (</span><span class="hl-8">v</span><span class="hl-1">) </span><span class="hl-3">=&gt;</span><span class="hl-1"> </span><span class="hl-8">v</span><br/><span class="hl-1">);</span><br/><br/><span class="hl-8">console</span><span class="hl-1">.</span><span class="hl-0">log</span><span class="hl-1">(</span><span class="hl-2">&quot;Connected to localhost:1337&quot;</span><span class="hl-1">);</span>
</code></pre>
</details>

<p><strong>Cheers!</strong> You&#39;ve created your first panrpc client. You can start it from your terminal like so:</p>
<pre><code class="language-shell"><span class="hl-0">$</span><span class="hl-1"> </span><span class="hl-2">npx</span><span class="hl-1"> </span><span class="hl-2">tsx</span><span class="hl-1"> </span><span class="hl-2">remote-control.ts</span>
</code></pre>
<p>You should now see the following in your terminal, which means that the client has connected to the panrpc server at <code>localhost:1337</code>:</p>
<pre><code class="language-plaintext">Connected to localhost:1337
1 coffee machines connected
</code></pre>
<p>Similarly so, the coffee machine server should output the following:</p>
<pre><code class="language-plaintext">1 remote controls connected
</code></pre>
</details>


<a href="#4-calling-the-server39s-rpcs-from-the-client-1" id="4-calling-the-server39s-rpcs-from-the-client-1" style="color: inherit; text-decoration: none;">
  <h4>4. Calling the Server&#39;s RPCs from the Client</h4>
</a>
<p>The coffee machine and the client are now connected to each other, but we haven&#39;t added the ability to call the <code>BrewCoffee</code> RPC from the remote control just yet. To fix this, we&#39;ll create a simple TUI interface that will print a list of available coffee variants and sizes to the terminal, waits for the user to make their choice by entering a number, and then calls the <code>BrewCoffee</code> RPC with the correct arguments. After the coffee has been brewed, we&#39;ll print the new water level to the terminal.</p>
<details>
  <summary>Expand section</summary>

<p>To achieve this, we can call this RPC transparently from the remote control by accessing the connected coffee machine(s) with <code>registry.forRemotes</code>, and we can handle errors with <code>try catch</code> just like if we were making a local function call:</p>
<pre><code class="language-typescript"><span class="hl-4">// remote-control.ts</span><br/><br/><span class="hl-6">import</span><span class="hl-1"> { </span><span class="hl-8">createInterface</span><span class="hl-1"> } </span><span class="hl-6">from</span><span class="hl-1"> </span><span class="hl-2">&quot;readline/promises&quot;</span><span class="hl-1">;</span><br/><br/><span class="hl-1">(</span><span class="hl-3">async</span><span class="hl-1"> () </span><span class="hl-3">=&gt;</span><span class="hl-1"> {</span><br/><span class="hl-1">  </span><span class="hl-8">console</span><span class="hl-1">.</span><span class="hl-0">log</span><span class="hl-1">(</span><span class="hl-2">`Enter one of the following numbers followed by &lt;ENTER&gt; to brew a coffee:</span><br/><br/><span class="hl-2">- 1: Brew small Cafè Latte</span><br/><span class="hl-2">- 2: Brew large Cafè Latte</span><br/><br/><span class="hl-2">- 3: Brew small Americano</span><br/><span class="hl-2">- 4: Brew large Americano`</span><span class="hl-1">);</span><br/><br/><span class="hl-1">  </span><span class="hl-3">const</span><span class="hl-1"> </span><span class="hl-11">rl</span><span class="hl-1"> = </span><span class="hl-0">createInterface</span><span class="hl-1">({ </span><span class="hl-8">input:</span><span class="hl-1"> </span><span class="hl-8">stdin</span><span class="hl-1">, </span><span class="hl-8">output:</span><span class="hl-1"> </span><span class="hl-8">stdout</span><span class="hl-1"> });</span><br/><br/><span class="hl-1">  </span><span class="hl-6">while</span><span class="hl-1"> (</span><span class="hl-3">true</span><span class="hl-1">) {</span><br/><span class="hl-1">    </span><span class="hl-3">const</span><span class="hl-1"> </span><span class="hl-11">line</span><span class="hl-1"> = </span><span class="hl-6">await</span><span class="hl-1"> </span><span class="hl-8">rl</span><span class="hl-1">.</span><span class="hl-0">question</span><span class="hl-1">(</span><span class="hl-2">&quot;&quot;</span><span class="hl-1">);</span><br/><br/><span class="hl-1">    </span><span class="hl-6">await</span><span class="hl-1"> </span><span class="hl-8">registry</span><span class="hl-1">.</span><span class="hl-0">forRemotes</span><span class="hl-1">(</span><span class="hl-3">async</span><span class="hl-1"> (</span><span class="hl-8">remoteID</span><span class="hl-1">, </span><span class="hl-8">remote</span><span class="hl-1">) </span><span class="hl-3">=&gt;</span><span class="hl-1"> {</span><br/><span class="hl-1">      </span><span class="hl-6">switch</span><span class="hl-1"> (</span><span class="hl-8">line</span><span class="hl-1">) {</span><br/><span class="hl-1">        </span><span class="hl-6">case</span><span class="hl-1"> </span><span class="hl-2">&quot;1&quot;</span><span class="hl-1">:</span><br/><span class="hl-1">        </span><span class="hl-6">case</span><span class="hl-1"> </span><span class="hl-2">&quot;2&quot;</span><span class="hl-1">:</span><br/><span class="hl-1">          </span><span class="hl-6">try</span><span class="hl-1"> {</span><br/><span class="hl-1">            </span><span class="hl-3">const</span><span class="hl-1"> </span><span class="hl-11">res</span><span class="hl-1"> = </span><span class="hl-6">await</span><span class="hl-1"> </span><span class="hl-8">remote</span><span class="hl-1">.</span><span class="hl-0">BrewCoffee</span><span class="hl-1">(</span><br/><span class="hl-1">              </span><span class="hl-3">undefined</span><span class="hl-1">,</span><br/><span class="hl-1">              </span><span class="hl-2">&quot;latte&quot;</span><span class="hl-1">,</span><br/><span class="hl-1">              </span><span class="hl-8">line</span><span class="hl-1"> === </span><span class="hl-2">&quot;1&quot;</span><span class="hl-1"> ? </span><span class="hl-7">100</span><span class="hl-1"> : </span><span class="hl-7">200</span><br/><span class="hl-1">            );</span><br/><br/><span class="hl-1">            </span><span class="hl-8">console</span><span class="hl-1">.</span><span class="hl-0">log</span><span class="hl-1">(</span><span class="hl-2">&quot;Remaining water:&quot;</span><span class="hl-1">, </span><span class="hl-8">res</span><span class="hl-1">, </span><span class="hl-2">&quot;ml&quot;</span><span class="hl-1">);</span><br/><span class="hl-1">          } </span><span class="hl-6">catch</span><span class="hl-1"> (</span><span class="hl-8">e</span><span class="hl-1">) {</span><br/><span class="hl-1">            </span><span class="hl-8">console</span><span class="hl-1">.</span><span class="hl-0">error</span><span class="hl-1">(</span><span class="hl-2">`Couldn&#39;t brew Cafè Latte: </span><span class="hl-3">${</span><span class="hl-8">e</span><span class="hl-3">}</span><span class="hl-2">`</span><span class="hl-1">);</span><br/><span class="hl-1">          }</span><br/><br/><span class="hl-1">          </span><span class="hl-6">break</span><span class="hl-1">;</span><br/><br/><span class="hl-1">        </span><span class="hl-6">case</span><span class="hl-1"> </span><span class="hl-2">&quot;3&quot;</span><span class="hl-1">:</span><br/><span class="hl-1">        </span><span class="hl-6">case</span><span class="hl-1"> </span><span class="hl-2">&quot;4&quot;</span><span class="hl-1">:</span><br/><span class="hl-1">          </span><span class="hl-6">try</span><span class="hl-1"> {</span><br/><span class="hl-1">            </span><span class="hl-3">const</span><span class="hl-1"> </span><span class="hl-11">res</span><span class="hl-1"> = </span><span class="hl-6">await</span><span class="hl-1"> </span><span class="hl-8">remote</span><span class="hl-1">.</span><span class="hl-0">BrewCoffee</span><span class="hl-1">(</span><br/><span class="hl-1">              </span><span class="hl-3">undefined</span><span class="hl-1">,</span><br/><span class="hl-1">              </span><span class="hl-2">&quot;americano&quot;</span><span class="hl-1">,</span><br/><span class="hl-1">              </span><span class="hl-8">line</span><span class="hl-1"> === </span><span class="hl-2">&quot;3&quot;</span><span class="hl-1"> ? </span><span class="hl-7">100</span><span class="hl-1"> : </span><span class="hl-7">200</span><br/><span class="hl-1">            );</span><br/><br/><span class="hl-1">            </span><span class="hl-8">console</span><span class="hl-1">.</span><span class="hl-0">log</span><span class="hl-1">(</span><span class="hl-2">&quot;Remaining water:&quot;</span><span class="hl-1">, </span><span class="hl-8">res</span><span class="hl-1">, </span><span class="hl-2">&quot;ml&quot;</span><span class="hl-1">);</span><br/><span class="hl-1">          } </span><span class="hl-6">catch</span><span class="hl-1"> (</span><span class="hl-8">e</span><span class="hl-1">) {</span><br/><span class="hl-1">            </span><span class="hl-8">console</span><span class="hl-1">.</span><span class="hl-0">error</span><span class="hl-1">(</span><span class="hl-2">`Couldn&#39;t brew Americano: </span><span class="hl-3">${</span><span class="hl-8">e</span><span class="hl-3">}</span><span class="hl-2">`</span><span class="hl-1">);</span><br/><span class="hl-1">          }</span><br/><br/><span class="hl-1">          </span><span class="hl-6">break</span><span class="hl-1">;</span><br/><br/><span class="hl-1">        </span><span class="hl-6">default</span><span class="hl-1">:</span><br/><span class="hl-1">          </span><span class="hl-8">console</span><span class="hl-1">.</span><span class="hl-0">log</span><span class="hl-1">(</span><span class="hl-2">`Unknown letter </span><span class="hl-3">${</span><span class="hl-8">line</span><span class="hl-3">}</span><span class="hl-2">, ignoring input`</span><span class="hl-1">);</span><br/><span class="hl-1">      }</span><br/><span class="hl-1">    });</span><br/><span class="hl-1">  }</span><br/><span class="hl-1">})();</span>
</code></pre>
<blockquote>
<p>Note that by aborting the <a href="https://developer.mozilla.org/en-US/docs/Web/API/AbortSignal">AbortSignal</a> that we can pass in as the first argument to every RPC call, you can abort an RPC call before it has returned, which is useful for <a href="https://developer.mozilla.org/en-US/docs/Web/API/AbortSignal#aborting_a_fetch_operation_with_a_timeout">implementing things like timeouts</a>. If you don&#39;t abort this <code>AbortSignal</code>, or pass in <code>undefined</code> like we do in this example, the RPC call will simply block until it returns.</p>
</blockquote>
<p>Now we can restart the remote control like so:</p>
<pre><code class="language-shell"><span class="hl-0">$</span><span class="hl-1"> </span><span class="hl-2">npx</span><span class="hl-1"> </span><span class="hl-2">tsx</span><span class="hl-1"> </span><span class="hl-2">remote-control.ts</span>
</code></pre>
<p>After which you should see the following output:</p>
<pre><code class="language-plaintext">Enter one of the following numbers followed by &lt;ENTER&gt; to brew a coffee:

- 1: Brew small Cafè Latte
- 2: Brew large Cafè Latte

- 3: Brew small Americano
- 4: Brew large Americano
1 coffee machines connected
Connected to localhost:1337
</code></pre>
<p>It is now possible to brew a coffee by pressing a number and <kbd>ENTER</kbd>. Once the RPC has been called, the coffee machine should print something like the following:</p>
<pre><code class="language-plaintext">Brewing coffee variant latte in size 100 ml
</code></pre>
<p>And after the coffee has been brewed, the remote control should return the remaining water level like so:</p>
<pre><code class="language-plaintext">Remaining water: 900 ml
</code></pre>
<p><strong>Enjoy your (virtual) coffee!</strong> You&#39;ve successfully called an RPC provided by a server from the client. Feel free to try out the other supported variants and sizes until there is no more water remaining.</p>
</details>


<a href="#5-calling-the-client39s-rpcs-from-the-server-1" id="5-calling-the-client39s-rpcs-from-the-server-1" style="color: inherit; text-decoration: none;">
  <h4>5. Calling the Client&#39;s RPCs from the Server</h4>
</a>
<p>So far, we&#39;ve enabled a remote control/client to call the <code>BrewCoffee</code> RPC on the coffee machine/server. This however means that if multiple remote controls are connected to one coffee machine, only the remote control that called the RPC is aware of coffee being brewed. In order to notify the other remote controls that coffee is being brewed, we will use panrpc to call a new RPC on the remote control/client from the coffee machine/server each time we brew coffee.</p>
<details>
  <summary>Expand section</summary>

<p>To get started, we can once again create a basic class on the client with a method <code>SetCoffeeMachineBrewing</code>, which will print the state of the coffee machine to the remote control&#39;s terminal:</p>
<pre><code class="language-typescript"><span class="hl-4">// remote-control.ts</span><br/><br/><span class="hl-3">class</span><span class="hl-1"> </span><span class="hl-5">RemoteControl</span><span class="hl-1"> {</span><br/><span class="hl-1">  </span><span class="hl-3">async</span><span class="hl-1"> </span><span class="hl-0">SetCoffeeMachineBrewing</span><span class="hl-1">(</span><span class="hl-8">ctx</span><span class="hl-1">: </span><span class="hl-5">ILocalContext</span><span class="hl-1">, </span><span class="hl-8">brewing</span><span class="hl-1">: </span><span class="hl-5">boolean</span><span class="hl-1">) {</span><br/><span class="hl-1">    </span><span class="hl-6">if</span><span class="hl-1"> (</span><span class="hl-8">brewing</span><span class="hl-1">) {</span><br/><span class="hl-1">      </span><span class="hl-8">console</span><span class="hl-1">.</span><span class="hl-0">log</span><span class="hl-1">(</span><span class="hl-2">&quot;Coffee machine is now brewing&quot;</span><span class="hl-1">);</span><br/><span class="hl-1">    } </span><span class="hl-6">else</span><span class="hl-1"> {</span><br/><span class="hl-1">      </span><span class="hl-8">console</span><span class="hl-1">.</span><span class="hl-0">log</span><span class="hl-1">(</span><span class="hl-2">&quot;Coffee machine has stopped brewing&quot;</span><span class="hl-1">);</span><br/><span class="hl-1">    }</span><br/><span class="hl-1">  }</span><br/><span class="hl-1">}</span>
</code></pre>
<p>To start turning this new <code>SetCoffeeMachineBrewing</code> method into an RPC that server can call, create an instance of the class and pass it to the client&#39;s registry like so:</p>
<pre><code class="language-typescript"><span class="hl-4">// remote-control.ts</span><br/><br/><span class="hl-3">const</span><span class="hl-1"> </span><span class="hl-11">registry</span><span class="hl-1"> = </span><span class="hl-3">new</span><span class="hl-1"> </span><span class="hl-0">Registry</span><span class="hl-1">(</span><br/><span class="hl-1">  </span><span class="hl-3">new</span><span class="hl-1"> </span><span class="hl-0">RemoteControl</span><span class="hl-1">(), </span><span class="hl-4">// This line is new</span><br/><span class="hl-1">  </span><span class="hl-3">new</span><span class="hl-1"> </span><span class="hl-0">CoffeeMachine</span><span class="hl-1">(),</span><br/><br/><span class="hl-1">  {</span><br/><span class="hl-1">    </span><span class="hl-0">onClientConnect</span><span class="hl-8">:</span><span class="hl-1"> () </span><span class="hl-3">=&gt;</span><span class="hl-1"> {</span><br/><span class="hl-1">      </span><span class="hl-8">clients</span><span class="hl-1">++;</span><br/><br/><span class="hl-1">      </span><span class="hl-8">console</span><span class="hl-1">.</span><span class="hl-0">log</span><span class="hl-1">(</span><span class="hl-8">clients</span><span class="hl-1">, </span><span class="hl-2">&quot;coffee machines connected&quot;</span><span class="hl-1">);</span><br/><span class="hl-1">    },</span><br/><span class="hl-1">    </span><span class="hl-0">onClientDisconnect</span><span class="hl-8">:</span><span class="hl-1"> () </span><span class="hl-3">=&gt;</span><span class="hl-1"> {</span><br/><span class="hl-1">      </span><span class="hl-8">clients</span><span class="hl-1">--;</span><br/><br/><span class="hl-1">      </span><span class="hl-8">console</span><span class="hl-1">.</span><span class="hl-0">log</span><span class="hl-1">(</span><span class="hl-8">clients</span><span class="hl-1">, </span><span class="hl-2">&quot;coffee machines connected&quot;</span><span class="hl-1">);</span><br/><span class="hl-1">    },</span><br/><span class="hl-1">  }</span><br/><span class="hl-1">);</span>
</code></pre>
<p>The remote control/client now exposes the <code>SetCoffeeMachineBrewing</code> RPC, and we can start enabling the coffee machine/server to call it by defining a basic class with a method that mirrors the RPC, just like we did before on the remote control for <code>BrewCoffee</code>:</p>
<pre><code class="language-typescript"><span class="hl-4">// coffee-machine.ts</span><br/><br/><span class="hl-3">class</span><span class="hl-1"> </span><span class="hl-5">RemoteControl</span><span class="hl-1"> {</span><br/><span class="hl-1">  </span><span class="hl-3">async</span><span class="hl-1"> </span><span class="hl-0">SetCoffeeMachineBrewing</span><span class="hl-1">(</span><span class="hl-8">ctx</span><span class="hl-1">: </span><span class="hl-5">IRemoteContext</span><span class="hl-1">, </span><span class="hl-8">brewing</span><span class="hl-1">: </span><span class="hl-5">boolean</span><span class="hl-1">) {}</span><br/><span class="hl-1">}</span>
</code></pre>
<p>In order to make the <code>SetCoffeeMachineBrewing</code> placeholder method do RPC calls, create an instance of the class and pass it to the server&#39;s registry like so:</p>
<pre><code class="language-typescript"><span class="hl-4">// coffee-machine.ts</span><br/><br/><span class="hl-3">const</span><span class="hl-1"> </span><span class="hl-11">registry</span><span class="hl-1"> = </span><span class="hl-3">new</span><span class="hl-1"> </span><span class="hl-0">Registry</span><span class="hl-1">(</span><br/><span class="hl-1">  </span><span class="hl-8">service</span><span class="hl-1">,</span><br/><span class="hl-1">  </span><span class="hl-3">new</span><span class="hl-1"> </span><span class="hl-0">RemoteControl</span><span class="hl-1">(), </span><span class="hl-4">// This line is new</span><br/><br/><span class="hl-1">  {</span><br/><span class="hl-1">    </span><span class="hl-0">onClientConnect</span><span class="hl-8">:</span><span class="hl-1"> () </span><span class="hl-3">=&gt;</span><span class="hl-1"> {</span><br/><span class="hl-1">      </span><span class="hl-8">clients</span><span class="hl-1">++;</span><br/><br/><span class="hl-1">      </span><span class="hl-8">console</span><span class="hl-1">.</span><span class="hl-0">log</span><span class="hl-1">(</span><span class="hl-8">clients</span><span class="hl-1">, </span><span class="hl-2">&quot;remote controls connected&quot;</span><span class="hl-1">);</span><br/><span class="hl-1">    },</span><br/><span class="hl-1">    </span><span class="hl-0">onClientDisconnect</span><span class="hl-8">:</span><span class="hl-1"> () </span><span class="hl-3">=&gt;</span><span class="hl-1"> {</span><br/><span class="hl-1">      </span><span class="hl-8">clients</span><span class="hl-1">--;</span><br/><br/><span class="hl-1">      </span><span class="hl-8">console</span><span class="hl-1">.</span><span class="hl-0">log</span><span class="hl-1">(</span><span class="hl-8">clients</span><span class="hl-1">, </span><span class="hl-2">&quot;remote controls connected&quot;</span><span class="hl-1">);</span><br/><span class="hl-1">    },</span><br/><span class="hl-1">  }</span><br/><span class="hl-1">);</span>
</code></pre>
<p>The coffee machine/server and the remote control/client now both know of the new <code>SetCoffeeMachineBrewing</code> RPC, but the server doesn&#39;t call it yet. To fix this, we can call this RPC transparently from the coffee machine by accessing the connected remote control(s) with <code>registry.forRemotes</code> just like we did before in the remote control, and we can handle errors with <code>try catch</code> just like if we were making a local function call. We&#39;ll also use the first argument to the RPC, <code>ILocalContext</code>, to get the ID of the remote control/client that is calling <code>BrewCoffee</code>, so that we don&#39;t call <code>SetCoffeeMachineBrewing</code> on the remote control/client that is calling <code>BrewCoffee</code> itself:</p>
<pre><code class="language-typescript"><span class="hl-4">// coffee-machine.ts</span><br/><br/><span class="hl-3">class</span><span class="hl-1"> </span><span class="hl-5">CoffeeMachine</span><span class="hl-1"> {</span><br/><span class="hl-1">  </span><span class="hl-3">public</span><span class="hl-1"> </span><span class="hl-0">forRemotes</span><span class="hl-1">?: (</span><br/><span class="hl-1">    </span><span class="hl-0">cb</span><span class="hl-1">: (</span><span class="hl-8">remoteID</span><span class="hl-1">: </span><span class="hl-5">string</span><span class="hl-1">, </span><span class="hl-8">remote</span><span class="hl-1">: </span><span class="hl-5">RemoteControl</span><span class="hl-1">) </span><span class="hl-3">=&gt;</span><span class="hl-1"> </span><span class="hl-5">Promise</span><span class="hl-1">&lt;</span><span class="hl-5">void</span><span class="hl-1">&gt;</span><br/><span class="hl-1">  ) </span><span class="hl-3">=&gt;</span><span class="hl-1"> </span><span class="hl-5">Promise</span><span class="hl-1">&lt;</span><span class="hl-5">void</span><span class="hl-1">&gt;;</span><br/><br/><span class="hl-1">  </span><span class="hl-4">// ...</span><br/><br/><span class="hl-1">  </span><span class="hl-3">async</span><span class="hl-1"> </span><span class="hl-0">BrewCoffee</span><span class="hl-1">(</span><br/><span class="hl-1">    </span><span class="hl-8">ctx</span><span class="hl-1">: </span><span class="hl-5">ILocalContext</span><span class="hl-1">,</span><br/><span class="hl-1">    </span><span class="hl-8">variant</span><span class="hl-1">: </span><span class="hl-5">string</span><span class="hl-1">,</span><br/><span class="hl-1">    </span><span class="hl-8">size</span><span class="hl-1">: </span><span class="hl-5">number</span><br/><span class="hl-1">  ): </span><span class="hl-5">Promise</span><span class="hl-1">&lt;</span><span class="hl-5">number</span><span class="hl-1">&gt; {</span><br/><span class="hl-1">    </span><span class="hl-4">// Get the ID of the remote control that&#39;s calling `BrewCoffee`</span><br/><span class="hl-1">    </span><span class="hl-3">const</span><span class="hl-1"> { </span><span class="hl-8">remoteID</span><span class="hl-1">: </span><span class="hl-11">targetID</span><span class="hl-1"> } = </span><span class="hl-8">ctx</span><span class="hl-1">;</span><br/><br/><span class="hl-1">    </span><span class="hl-6">try</span><span class="hl-1"> {</span><br/><span class="hl-1">      </span><span class="hl-4">// Notify connected remote controls that coffee is brewing</span><br/><span class="hl-1">      </span><span class="hl-6">await</span><span class="hl-1"> </span><span class="hl-3">this</span><span class="hl-1">.</span><span class="hl-0">forRemotes</span><span class="hl-1">?.(</span><span class="hl-3">async</span><span class="hl-1"> (</span><span class="hl-8">remoteID</span><span class="hl-1">, </span><span class="hl-8">remote</span><span class="hl-1">) </span><span class="hl-3">=&gt;</span><span class="hl-1"> {</span><br/><span class="hl-1">        </span><span class="hl-4">// Don&#39;t call `SetCoffeeMachineBrewing` if it&#39;s the remote control that&#39;s calling `BrewCoffee`</span><br/><span class="hl-1">        </span><span class="hl-6">if</span><span class="hl-1"> (</span><span class="hl-8">remoteID</span><span class="hl-1"> === </span><span class="hl-8">targetID</span><span class="hl-1">) {</span><br/><span class="hl-1">          </span><span class="hl-6">return</span><span class="hl-1">;</span><br/><span class="hl-1">        }</span><br/><br/><span class="hl-1">        </span><span class="hl-6">await</span><span class="hl-1"> </span><span class="hl-8">remote</span><span class="hl-1">.</span><span class="hl-0">SetCoffeeMachineBrewing</span><span class="hl-1">(</span><span class="hl-3">undefined</span><span class="hl-1">, </span><span class="hl-3">true</span><span class="hl-1">);</span><br/><span class="hl-1">      });</span><br/><br/><span class="hl-1">      </span><span class="hl-6">if</span><span class="hl-1"> (!</span><span class="hl-3">this</span><span class="hl-1">.</span><span class="hl-8">supportedVariants</span><span class="hl-1">.</span><span class="hl-0">includes</span><span class="hl-1">(</span><span class="hl-8">variant</span><span class="hl-1">)) {</span><br/><span class="hl-1">        </span><span class="hl-6">throw</span><span class="hl-1"> </span><span class="hl-3">new</span><span class="hl-1"> </span><span class="hl-0">Error</span><span class="hl-1">(</span><span class="hl-2">&quot;unsupported variant&quot;</span><span class="hl-1">);</span><br/><span class="hl-1">      }</span><br/><br/><span class="hl-1">      </span><span class="hl-6">if</span><span class="hl-1"> (</span><span class="hl-3">this</span><span class="hl-1">.</span><span class="hl-8">waterLevel</span><span class="hl-1"> - </span><span class="hl-8">size</span><span class="hl-1"> &lt; </span><span class="hl-7">0</span><span class="hl-1">) {</span><br/><span class="hl-1">        </span><span class="hl-6">throw</span><span class="hl-1"> </span><span class="hl-3">new</span><span class="hl-1"> </span><span class="hl-0">Error</span><span class="hl-1">(</span><span class="hl-2">&quot;not enough water&quot;</span><span class="hl-1">);</span><br/><span class="hl-1">      }</span><br/><br/><span class="hl-1">      </span><span class="hl-8">console</span><span class="hl-1">.</span><span class="hl-0">log</span><span class="hl-1">(</span><span class="hl-2">&quot;Brewing coffee variant&quot;</span><span class="hl-1">, </span><span class="hl-8">variant</span><span class="hl-1">, </span><span class="hl-2">&quot;in size&quot;</span><span class="hl-1">, </span><span class="hl-8">size</span><span class="hl-1">, </span><span class="hl-2">&quot;ml&quot;</span><span class="hl-1">);</span><br/><br/><span class="hl-1">      </span><span class="hl-6">await</span><span class="hl-1"> </span><span class="hl-3">new</span><span class="hl-1"> </span><span class="hl-5">Promise</span><span class="hl-1">((</span><span class="hl-8">r</span><span class="hl-1">) </span><span class="hl-3">=&gt;</span><span class="hl-1"> {</span><br/><span class="hl-1">        </span><span class="hl-0">setTimeout</span><span class="hl-1">(</span><span class="hl-8">r</span><span class="hl-1">, </span><span class="hl-7">5000</span><span class="hl-1">);</span><br/><span class="hl-1">      });</span><br/><span class="hl-1">    } </span><span class="hl-6">finally</span><span class="hl-1"> {</span><br/><span class="hl-1">      </span><span class="hl-4">// Notify connected remote controls that coffee is no longer brewing</span><br/><span class="hl-1">      </span><span class="hl-6">await</span><span class="hl-1"> </span><span class="hl-3">this</span><span class="hl-1">.</span><span class="hl-0">forRemotes</span><span class="hl-1">?.(</span><span class="hl-3">async</span><span class="hl-1"> (</span><span class="hl-8">remoteID</span><span class="hl-1">, </span><span class="hl-8">remote</span><span class="hl-1">) </span><span class="hl-3">=&gt;</span><span class="hl-1"> {</span><br/><span class="hl-1">        </span><span class="hl-4">// Don&#39;t call `SetCoffeeMachineBrewing` if it&#39;s the remote control that&#39;s calling `BrewCoffee`</span><br/><span class="hl-1">        </span><span class="hl-6">if</span><span class="hl-1"> (</span><span class="hl-8">remoteID</span><span class="hl-1"> === </span><span class="hl-8">targetID</span><span class="hl-1">) {</span><br/><span class="hl-1">          </span><span class="hl-6">return</span><span class="hl-1">;</span><br/><span class="hl-1">        }</span><br/><br/><span class="hl-1">        </span><span class="hl-6">await</span><span class="hl-1"> </span><span class="hl-8">remote</span><span class="hl-1">.</span><span class="hl-0">SetCoffeeMachineBrewing</span><span class="hl-1">(</span><span class="hl-3">undefined</span><span class="hl-1">, </span><span class="hl-3">false</span><span class="hl-1">);</span><br/><span class="hl-1">      });</span><br/><span class="hl-1">    }</span><br/><br/><span class="hl-1">    </span><span class="hl-3">this</span><span class="hl-1">.</span><span class="hl-8">waterLevel</span><span class="hl-1"> -= </span><span class="hl-8">size</span><span class="hl-1">;</span><br/><br/><span class="hl-1">    </span><span class="hl-6">return</span><span class="hl-1"> </span><span class="hl-3">this</span><span class="hl-1">.</span><span class="hl-8">waterLevel</span><span class="hl-1">;</span><br/><span class="hl-1">  }</span><br/><span class="hl-1">}</span>
</code></pre>
<p>Note that we&#39;ve added the <code>forRemotes</code> field to the coffee machine/server; we can get the implementation for it from the registry like so:</p>
<pre><code class="language-typescript"><span class="hl-4">// coffee-machine.ts</span><br/><br/><span class="hl-3">const</span><span class="hl-1"> </span><span class="hl-11">service</span><span class="hl-1"> = </span><span class="hl-4">// ...</span><br/><br/><span class="hl-3">const</span><span class="hl-1"> </span><span class="hl-11">registry</span><span class="hl-1"> = </span><span class="hl-4">// ...</span><br/><br/><span class="hl-8">service</span><span class="hl-1">.</span><span class="hl-8">forRemotes</span><span class="hl-1"> = </span><span class="hl-8">registry</span><span class="hl-1">.</span><span class="hl-8">forRemotes</span><span class="hl-1">;</span>
</code></pre>
<p>Now that we&#39;ve added support for this RPC to the coffee machine/server, we can restart it like so:</p>
<pre><code class="language-shell"><span class="hl-0">$</span><span class="hl-1"> </span><span class="hl-2">npx</span><span class="hl-1"> </span><span class="hl-2">tsx</span><span class="hl-1"> </span><span class="hl-2">coffee-machine.ts</span>
</code></pre>
<p>To test if it works, connect two remote controls/clients to it like so:</p>
<pre><code class="language-shell"><span class="hl-0">$</span><span class="hl-1"> </span><span class="hl-2">npx</span><span class="hl-1"> </span><span class="hl-2">tsx</span><span class="hl-1"> </span><span class="hl-2">remote-control.ts</span><br/><span class="hl-4"># In another terminal</span><br/><span class="hl-0">$</span><span class="hl-1"> </span><span class="hl-2">npx</span><span class="hl-1"> </span><span class="hl-2">tsx</span><span class="hl-1"> </span><span class="hl-2">remote-control.ts</span>
</code></pre>
<p>You can now request the coffee machine to brew a coffee on either of the remote controls by pressing a number and <kbd>ENTER</kbd>. Once the RPC has been called, the coffee machine should print something like the following again:</p>
<pre><code class="language-plaintext">Brewing coffee variant latte in size 100 ml
</code></pre>
<p>And after the coffee has been brewed, the remote control that you&#39;ve chosen to brew the coffee with should once again return the remaining water level like so:</p>
<pre><code class="language-plaintext">Remaining water: 900 ml
</code></pre>
<p>The other connected remote controls will be notified that the coffee machine is brewing, and then once it has finished brewing:</p>
<pre><code class="language-plaintext">Coffee machine is now brewing
Coffee machine has stopped brewing
</code></pre>
<p><strong>Enjoy your distributed coffee machine!</strong> You&#39;ve successfully called an RPC provided by a client from the server to implement multicast notifications, something that usually is quite complex to do with RPC systems.</p>
</details>


<a href="#6-passing-closures-to-rpcs-1" id="6-passing-closures-to-rpcs-1" style="color: inherit; text-decoration: none;">
  <h4>6. Passing Closures to RPCs</h4>
</a>
<p>So far, when the remote control/client calls the <code>BrewCoffee</code> RPC, there is no way of knowing the incremental progress of the brew other than waiting for <code>BrewCoffee</code> to return the new water level. In order to know of the progress of the coffee machine as it is brewing, we can make use of the closure/callback support in panrpc, which allows us to pass a function to an RPC call, just like you could do locally.</p>
<details>
  <summary>Expand section</summary>

<p>First, we&#39;ll add a <code>onProgress</code> callback to the coffee machine&#39;s <code>BrewCoffee</code> implementation and decorate it with [panrpc&#39;s</p>
</div></div>
<div class="col-4 col-menu menu-sticky-wrap menu-highlight">
<div class="tsd-navigation settings">
<details class="tsd-index-accordion"><summary class="tsd-accordion-summary">
<h3><svg width="20" height="20" viewBox="0 0 24 24" fill="none"><path d="M4.93896 8.531L12 15.591L19.061 8.531L16.939 6.409L12 11.349L7.06098 6.409L4.93896 8.531Z" fill="var(--color-text)"></path></svg> Settings</h3></summary>
<div class="tsd-accordion-details">
<div class="tsd-filter-visibility">
<h4 class="uppercase">Member Visibility</h4><form>
<ul id="tsd-filter-options">
<li class="tsd-filter-item"><label class="tsd-filter-input"><input type="checkbox" id="tsd-filter-protected" name="protected"/><svg width="32" height="32" viewBox="0 0 32 32" aria-hidden="true"><rect class="tsd-checkbox-background" width="30" height="30" x="1" y="1" rx="6" fill="none"></rect><path class="tsd-checkbox-checkmark" d="M8.35422 16.8214L13.2143 21.75L24.6458 10.25" stroke="none" stroke-width="3.5" stroke-linejoin="round" fill="none"></path></svg><span>Protected</span></label></li>
<li class="tsd-filter-item"><label class="tsd-filter-input"><input type="checkbox" id="tsd-filter-inherited" name="inherited" checked/><svg width="32" height="32" viewBox="0 0 32 32" aria-hidden="true"><rect class="tsd-checkbox-background" width="30" height="30" x="1" y="1" rx="6" fill="none"></rect><path class="tsd-checkbox-checkmark" d="M8.35422 16.8214L13.2143 21.75L24.6458 10.25" stroke="none" stroke-width="3.5" stroke-linejoin="round" fill="none"></path></svg><span>Inherited</span></label></li>
<li class="tsd-filter-item"><label class="tsd-filter-input"><input type="checkbox" id="tsd-filter-external" name="external"/><svg width="32" height="32" viewBox="0 0 32 32" aria-hidden="true"><rect class="tsd-checkbox-background" width="30" height="30" x="1" y="1" rx="6" fill="none"></rect><path class="tsd-checkbox-checkmark" d="M8.35422 16.8214L13.2143 21.75L24.6458 10.25" stroke="none" stroke-width="3.5" stroke-linejoin="round" fill="none"></path></svg><span>External</span></label></li></ul></form></div>
<div class="tsd-theme-toggle">
<h4 class="uppercase">Theme</h4><select id="theme"><option value="os">OS</option><option value="light">Light</option><option value="dark">Dark</option></select></div></div></details></div>
<nav class="tsd-navigation primary">
<details class="tsd-index-accordion" open><summary class="tsd-accordion-summary">
<h3><svg width="20" height="20" viewBox="0 0 24 24" fill="none"><path d="M4.93896 8.531L12 15.591L19.061 8.531L16.939 6.409L12 11.349L7.06098 6.409L4.93896 8.531Z" fill="var(--color-text)"></path></svg> Modules</h3></summary>
<div class="tsd-accordion-details">
<ul>
<li class="current selected"><a href="modules.html">@pojntfx/panrpc</a>
<ul></ul></li></ul></div></details></nav>
<nav class="tsd-navigation secondary menu-sticky">
<ul>
<li class="tsd-kind-class"><a href="classes/Registry.html" class="tsd-index-link"><svg class="tsd-kind-icon" width="24" height="24" viewBox="0 0 24 24"><rect fill="var(--color-icon-background)" stroke="var(--color-ts-class)" stroke-width="1.5" x="1" y="1" width="22" height="22" rx="6" id="icon-128-path"></rect><path d="M11.898 16.1201C11.098 16.1201 10.466 15.8961 10.002 15.4481C9.53803 15.0001 9.30603 14.3841 9.30603 13.6001V9.64012C9.30603 8.85612 9.53803 8.24012 10.002 7.79212C10.466 7.34412 11.098 7.12012 11.898 7.12012C12.682 7.12012 13.306 7.34812 13.77 7.80412C14.234 8.25212 14.466 8.86412 14.466 9.64012H13.386C13.386 9.14412 13.254 8.76412 12.99 8.50012C12.734 8.22812 12.37 8.09212 11.898 8.09212C11.426 8.09212 11.054 8.22412 10.782 8.48812C10.518 8.75212 10.386 9.13212 10.386 9.62812V13.6001C10.386 14.0961 10.518 14.4801 10.782 14.7521C11.054 15.0161 11.426 15.1481 11.898 15.1481C12.37 15.1481 12.734 15.0161 12.99 14.7521C13.254 14.4801 13.386 14.0961 13.386 13.6001H14.466C14.466 14.3761 14.234 14.9921 13.77 15.4481C13.306 15.8961 12.682 16.1201 11.898 16.1201Z" fill="var(--color-text)" id="icon-128-text"></path></svg>Registry</a></li>
<li class="tsd-kind-interface"><a href="interfaces/ILocalContext.html" class="tsd-index-link"><svg class="tsd-kind-icon" width="24" height="24" viewBox="0 0 24 24"><rect fill="var(--color-icon-background)" stroke="var(--color-ts-interface)" stroke-width="1.5" x="1" y="1" width="22" height="22" rx="6" id="icon-256-path"></rect><path d="M9.51 16V15.016H11.298V8.224H9.51V7.24H14.19V8.224H12.402V15.016H14.19V16H9.51Z" fill="var(--color-text)" id="icon-256-text"></path></svg>ILocal<wbr/>Context</a></li>
<li class="tsd-kind-interface"><a href="interfaces/IMessage.html" class="tsd-index-link"><svg class="tsd-kind-icon" width="24" height="24" viewBox="0 0 24 24"><use href="#icon-256-path"></use><use href="#icon-256-text"></use></svg>IMessage</a></li>
<li class="tsd-kind-interface"><a href="interfaces/IOptions.html" class="tsd-index-link"><svg class="tsd-kind-icon" width="24" height="24" viewBox="0 0 24 24"><use href="#icon-256-path"></use><use href="#icon-256-text"></use></svg>IOptions</a></li>
<li class="tsd-kind-type-alias"><a href="types/IRemoteContext.html" class="tsd-index-link"><svg class="tsd-kind-icon" width="24" height="24" viewBox="0 0 24 24"><rect fill="var(--color-icon-background)" stroke="var(--color-ts)" stroke-width="1.5" x="1" y="1" width="22" height="22" rx="6" id="icon-4194304-path"></rect><path d="M11.31 16V8.224H8.91V7.24H14.79V8.224H12.39V16H11.31Z" fill="var(--color-text)" id="icon-4194304-text"></path></svg>IRemote<wbr/>Context</a></li>
<li class="tsd-kind-variable"><a href="variables/ErrorCallCancelled.html" class="tsd-index-link"><svg class="tsd-kind-icon" width="24" height="24" viewBox="0 0 24 24"><rect fill="var(--color-icon-background)" stroke="var(--color-ts-variable)" stroke-width="1.5" x="1" y="1" width="22" height="22" rx="6" id="icon-32-path"></rect><path d="M11.106 16L8.85 7.24H9.966L11.454 13.192C11.558 13.608 11.646 13.996 11.718 14.356C11.79 14.708 11.842 14.976 11.874 15.16C11.906 14.976 11.954 14.708 12.018 14.356C12.09 13.996 12.178 13.608 12.282 13.192L13.758 7.24H14.85L12.582 16H11.106Z" fill="var(--color-text)" id="icon-32-text"></path></svg>Error<wbr/>Call<wbr/>Cancelled</a></li>
<li class="tsd-kind-variable"><a href="variables/ErrorCannotCallNonFunction.html" class="tsd-index-link"><svg class="tsd-kind-icon" width="24" height="24" viewBox="0 0 24 24"><use href="#icon-32-path"></use><use href="#icon-32-text"></use></svg>Error<wbr/>Cannot<wbr/>Call<wbr/>Non<wbr/>Function</a></li>
<li class="tsd-kind-variable"><a href="variables/ErrorClosureDoesNotExist.html" class="tsd-index-link"><svg class="tsd-kind-icon" width="24" height="24" viewBox="0 0 24 24"><use href="#icon-32-path"></use><use href="#icon-32-text"></use></svg>Error<wbr/>Closure<wbr/>Does<wbr/>Not<wbr/>Exist</a></li>
<li class="tsd-kind-function"><a href="functions/remoteClosure.html" class="tsd-index-link"><svg class="tsd-kind-icon" width="24" height="24" viewBox="0 0 24 24"><rect fill="var(--color-icon-background)" stroke="var(--color-ts-function)" stroke-width="1.5" x="1" y="1" width="22" height="22" rx="6" id="icon-64-path"></rect><path d="M9.39 16V7.24H14.55V8.224H10.446V11.128H14.238V12.112H10.47V16H9.39Z" fill="var(--color-text)" id="icon-64-text"></path></svg>remote<wbr/>Closure</a></li></ul></nav></div></div>
<div class="container tsd-generator">
<p>Generated using <a href="https://typedoc.org/" target="_blank">TypeDoc</a></p></div>
<div class="overlay"></div><script src="assets/main.js"></script></body></html>