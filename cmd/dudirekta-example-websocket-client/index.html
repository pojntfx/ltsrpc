<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>dudirekta WebSocket Client Demo</title>
  </head>
  <body>
    <script>
      const socket = new WebSocket("ws://localhost:1337");

      const local = {
        Println: async (msg) => alert(msg),
      };
      const remote = {
        Increment: async (delta) => {},
      };

      for (let functionName in remote) {
        remote[functionName] = async (...args) => {
          return new Promise(async (res, rej) => {
            const id = Math.random().toString(16).slice(2);

            const handleReturn = ({ detail }) => {
              const [rv, err] = detail;

              if (err) {
                rej(new Error(err));
              } else {
                res(rv);
              }

              window.removeEventListener(`rpc:${id}`, handleReturn);
            };

            window.addEventListener(`rpc:${id}`, handleReturn);

            socket.send(JSON.stringify([true, id, functionName, args]));
          });
        };
      }

      socket.addEventListener("message", async (e) => {
        const msg = JSON.parse(e.data);

        if (msg[0]) {
          const [_, id, functionName, args] = msg;

          try {
            const res = await local[functionName](...args);

            socket.send(JSON.stringify([false, id, res, ""]));
          } catch (e) {
            socket.send(JSON.stringify([false, id, "", e.message]));
          }
        } else {
          window.dispatchEvent(
            new CustomEvent(`rpc:${msg[1]}`, {
              detail: msg.slice(2),
            })
          );
        }
      });
    </script>

    <h1>dudirekta WebSocket Client Demo</h1>

    <p>Current value: <span id="current-value">0</span></p>

    <button id="increment">Increment</button>
    <button id="decrement">Decrement</button>

    <script>
      document
        .getElementById("increment")
        .addEventListener("click", async () => {
          document.getElementById("current-value").innerText =
            await remote.Increment(1);
        });

      document
        .getElementById("decrement")
        .addEventListener("click", async () => {
          document.getElementById("current-value").innerText =
            await remote.Increment(-1);
        });
    </script>
  </body>
</html>
